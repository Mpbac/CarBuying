<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enrollment Form: Car Buying Study</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <style>
    :root {
      --dartmouth-green: #00693e;
      --forest-green: #228B22;
      --off-white: #f8f8f8;
    }

    body {
      background-color: var(--off-white);
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .form-card {
      max-width: 700px;
      margin: 20px auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 10px;
      overflow: hidden;
    }
    .hidden {
      display: none;
    }
    .message-box {
      margin: 20px auto;
      max-width: 600px;
      padding: 20px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
    }
    .message-box.is-danger {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }
    .message-box.is-success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }
    .title.is-4 {
      color: var(--dartmouth-green);
      text-align: center;
      padding: 20px 0 10px;
      background-color: white;
      border-bottom: 1px solid #e0e0e0;
    }
    .content-area {
      padding: 30px;
      background-color: white;
    }
    .field:not(:last-child) {
      margin-bottom: 1.5rem;
    }
    .control .input, .control .textarea, .control .select select {
      border-color: #dbdbdb;
      box-shadow: none;
    }
    .control .input:focus, .control .textarea:focus, .control .select select:focus {
      border-color: var(--dartmouth-green);
      box-shadow: 0 0 0 0.125em rgba(0, 105, 62, 0.25);
    }
    .button.is-primary {
      background-color: var(--dartmouth-green);
      border-color: transparent;
      transition: background-color 0.3s;
    }
    .button.is-primary:hover {
      background-color: #004d2e;
    }
    .help {
      font-size: 0.85em;
      margin-top: 5px;
      color: #666;
    }
    .modal-card-body {
        max-height: 80vh; /* Limit height */
        overflow-y: auto; /* Enable scrolling */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    .is-fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: white;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
  </style>
</head>
<body>

  <div class="form-card" id="formCard">
    <h4 class="title is-4">Car Buying Study Enrollment Form</h4>
    <div class="content-area">

      <div id="ageCheckSection">
        <div class="field">
          <label class="label">Are you 18 years of age or older?</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="age18OrOver" value="Yes" required> Yes
            </label>
            <label class="radio">
              <input type="radio" name="age18OrOver" value="No"> No
            </label>
          </div>
          <p class="help" id="ageEligibilityMessage" style="color: red; display: none;">Sorry, you must be 18 years or older to participate.</p>
        </div>
        <div class="field">
          <div class="control">
            <button class="button is-primary" id="ageNextBtn">Next</button>
          </div>
        </div>
      </div>

      <div id="purchasePlanSection" class="hidden">
        <div class="field">
          <label class="label">Are you planning to purchase a car within the next 6 months?</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="purchasePlan" value="Yes" required> Yes
            </label>
            <label class="radio">
              <input type="radio" name="purchasePlan" value="No"> No
            </label>
            <label class="radio">
              <input type="radio" name="purchasePlan" value="Maybe"> Maybe
            </label>
          </div>
          <p class="help" id="purchaseEligibilityMessage" style="color: red; display: none;">Sorry, this study is for individuals planning to purchase a car within the next 6 months.</p>
        </div>
        <div class="field">
          <div class="control">
            <button class="button is-primary" id="purchaseNextBtn">Next</button>
          </div>
        </div>
      </div>

      <div id="paymentPlanSection" class="hidden">
        <div class="field">
          <label class="label">Do you plan to finance, lease, or pay in cash for your next vehicle purchase?</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="paymentPlan" value="Finance" required> Finance
            </label>
            <label class="radio">
              <input type="radio" name="paymentPlan" value="Lease"> Lease
            </label>
            <label class="radio">
              <input type="radio" name="paymentPlan" value="Cash"> Cash
            </label>
          </div>
          <p class="help" id="paymentEligibilityMessage" style="color: red; display: none;">Sorry, your payment plan does not align with the study requirements.</p>
        </div>
        <div class="field">
          <div class="control">
            <button class="button is-primary" id="paymentNextBtn">Continue to Consent</button>
          </div>
        </div>
      </div>

      <div class="modal" id="consentModal">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Informed Consent for Car Buying Study</p>
          </header>
          <section class="modal-card-body">
            <div class="content">
              <h4>Study Title: The Car Buying Study</h4>
              <p>You are invited to participate in a research study being conducted by Dartmouth College. Your participation is entirely voluntary. Please read the following information carefully.</p>

              <h5>Purpose of the Study:</h5>
              <p>The purpose of this study is to understand the factors that influence consumers' car buying decisions, including the role of online information, dealerships, and financing options.</p>

              <h5>What will I do if I participate?</h5>
              <ol>
                <li>You will first complete an enrollment form to determine eligibility.</li>
                <li>If eligible, you will provide your informed consent to participate.</li>
                <li>You will then be asked to review content related to car buying.</li>
                <li>After reviewing the content, you will answer a series of demographic questions.</li>
                <li>Finally, you will submit your responses.</li>
                <li>(Optional) If you buy a car in the next month, you can return to provide details of your purchase for additional compensation.</li>
              </ol>

              <h5>Compensation:</h5>
              <ul>
                <li>Upon successful completion of the enrollment form, content review, and demographic survey, you will receive $5 via PayPal.</li>
                <li>If you proceed to purchase a vehicle within the next month and provide documentation of the purchase, you will receive an additional $20 via PayPal.</li>
              </ul>

              <h5>Confidentiality:</h5>
              <p>All information you provide will be kept confidential to the extent permitted by law. Your responses will be anonymized for analysis, and any personally identifiable information (e.g., email, phone number, IP address, geolocation) will be stored separately from your survey responses and used only for compensation, follow-up, and to prevent duplicate entries. Data will be stored on secure, password-protected servers at Dartmouth College.</p>

              <h5>Risks and Benefits:</h5>
              <p>There are no anticipated risks beyond those encountered in daily internet use. The direct benefit to you is the compensation described above. The broader benefit is contributing to academic research on consumer behavior in the automotive market.</p>

              <h5>Voluntary Participation:</h5>
              <p>Participation in this study is completely voluntary. You may withdraw at any time without penalty or loss of benefits. You may skip any question you do not wish to answer.</p>

              <h5>Contact Information:</h5>
              <p>If you have any questions about this research, you may contact [Your Name/Research Team Name] at carbuyingstudy@dartmouth.edu.</p>
              <p>If you have any questions about your rights as a research participant, you may contact the Dartmouth College Institutional Review Board (IRB) at [IRB contact info - if applicable, otherwise omit or use a general IRB contact if required by your institution].</p>

              <hr>
              <p><strong>By clicking "I Consent" below, you acknowledge that you have read and understood the information provided, and you voluntarily agree to participate in this study.</strong></p>
            </div>
          </section>
          <footer class="modal-card-foot is-fixed-bottom">
            <button class="button is-success" id="consentBtn">I Consent</button>
            <button class="button" id="declineConsentBtn">Decline</button>
          </footer>
        </div>
      </div>

      <div class="message-box is-danger hidden" id="disqualificationMessage">
        <p>Sorry, you do not meet the eligibility requirements for this study. Thank you for your interest.</p>
        <button class="button is-small is-danger mt-3" id="restartFormBtn">Restart Form</button>
      </div>

      <div id="introExplanationContent" class="hidden">
        <p>Thank you for your interest in the Car Buying Study!</p>
        <p>We are conducting research to understand consumer decision-making when purchasing a vehicle. Your participation involves completing a short enrollment form, reviewing some content, and answering a few demographic questions. Eligible participants will receive $5 via PayPal upon completion of the initial survey. If you purchase a car within the next month, you may also be eligible for an additional $20.</p>
        <p>Please provide the following information to proceed.</p>
      </div>


      <div class="modal" id="contentModal">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Please review the content below</p>
          </header>
          <section class="modal-card-body has-text-centered">
            <iframe id="webpageIframe" style="width:100%; height:60vh; border:none;"></iframe>
            <div class="field mt-4">
              <label class="checkbox">
                <input type="checkbox" id="contentCertifiedCheckbox" required>
                I certify that I have read and reviewed the content above.
              </label>
              <p class="help is-danger hidden" id="contentCertifiedMessage">Please certify that you have reviewed the content to proceed.</p>
            </div>
          </section>
          <footer class="modal-card-foot is-fixed-bottom">
            <button class="button is-primary" id="contentReviewedBtn">Continue to Demographics</button>
          </footer>
        </div>
      </div>


      <form id="submissionForm" class="hidden">

        <input type="hidden" name="timestamp" id="timestampField">
        <input type="hidden" name="disqualificationReason" id="disqualificationReasonField" value="Not Disqualified">
        <input type="hidden" name="age18OrOverInitial" id="age18OrOverInitialField">
        <input type="hidden" name="purchaseInitial" id="purchaseInitialField">
        <input type="hidden" name="paymentPlanInitial" id="paymentPlanInitialField">
        <input type="hidden" name="consentStatus" id="consentStatusField" value="No Consent">
        <input type="hidden" name="viewedWebpageUrl" id="viewedWebpageUrlField">
        <input type="hidden" name="timeOnContentPageMs" id="timeOnContentPageMsField" value="0">
        <input type="hidden" name="clientFetchedIp" id="clientFetchedIpField" value="N/A_ClientFetch_Skipped">
        <input type="hidden" name="honeypot" id="honeypotField" value=""> <input type="hidden" name="latitude" id="latitudeField" value="N/A">
        <input type="hidden" name="longitude" id="longitudeField" value="N/A">
        <input type="hidden" name="locationAccuracy" id="locationAccuracyField" value="N/A">
        <input type="hidden" name="locationStatus" id="locationStatusField" value="Pending">

        <div class="field">
          <p class="help is-info" id="locationMessage">Attempting to get your location for research purposes...</p>
        </div>
        <h5 class="title is-5">Participant Information (Demographics)</h5>

        <div class="field">
          <label class="label">Full Name</label>
          <div class="control">
            <input class="input" type="text" name="fullName" placeholder="Your Full Name" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Email</label>
          <div class="control">
            <input class="input" type="email" name="email" placeholder="email@example.com" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Phone Number (Optional for SMS follow-up)</label>
          <div class="control">
            <input class="input" type="tel" name="phoneNumber" placeholder="e.g., 123-456-7890">
          </div>
          <p class="help">We may use this to send follow-up texts if you opt-in.</p>
        </div>

        <div class="field">
          <label class="label">Age</label>
          <div class="control">
            <input class="input" type="number" name="age" min="18" max="100" placeholder="e.g., 30" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Gender</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="gender" value="Male" required> Male
            </label>
            <label class="radio">
              <input type="radio" name="gender" value="Female"> Female
            </label>
            <label class="radio">
              <input type="radio" name="gender" value="Non-binary"> Non-binary
            </label>
            <label class="radio">
              <input type="radio" name="gender" value="Prefer not to say"> Prefer not to say
            </label>
          </div>
        </div>

        <div class="field">
          <label class="label">Race/Ethnicity (Select all that apply)</label>
          <div class="control">
            <label class="checkbox">
              <input type="checkbox" name="race" value="American Indian or Alaska Native"> American Indian or Alaska Native
            </label><br>
            <label class="checkbox">
              <input type="checkbox" name="race" value="Asian"> Asian
            </label><br>
            <label class="checkbox">
              <input type="checkbox" name="race" value="Black or African American"> Black or African American
            </label><br>
            <label class="checkbox">
              <input type="checkbox" name="race" value="Native Hawaiian or Other Pacific Islander"> Native Hawaiian or Other Pacific Islander
            </label><br>
            <label class="checkbox">
              <input type="checkbox" name="race" value="White"> White
            </label><br>
            <label class="checkbox">
              <input type="checkbox" name="race" value="Other"> Other
            </label>
          </div>
        </div>

        <div class="field">
          <label class="label">Are you of Hispanic, Latino, or Spanish origin?</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="hispanic" value="Yes" required> Yes
            </label>
            <label class="radio">
              <input type="radio" name="hispanic" value="No"> No
            </label>
            <label class="radio">
              <input type="radio" name="hispanic" value="Prefer not to say"> Prefer not to say
            </label>
          </div>
        </div>

        <div class="field">
          <label class="label">Highest level of education completed</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select name="education" required>
                <option value="">Select an option</option>
                <option value="Less than High School">Less than High School</option>
                <option value="High School Diploma/GED">High School Diploma/GED</option>
                <option value="Some College (no degree)">Some College (no degree)</option>
                <option value="Associate's Degree">Associate's Degree</option>
                <option value="Bachelor's Degree">Bachelor's Degree</option>
                <option value="Master's Degree">Master's Degree</option>
                <option value="Doctorate or Professional Degree">Doctorate or Professional Degree</option>
              </select>
            </div>
        </div>
      </div>

        <div class="field">
          <label class="label">Current Occupation</label>
          <div class="control">
            <input class="input" type="text" name="occupation" placeholder="e.g., Engineer, Student, Retired" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Approximate annual household income</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select name="householdIncome" required>
                <option value="">Select an option</option>
                <option value="Under $25,000">Under $25,000</option>
                <option value="$25,000 - $49,999">$25,000 - $49,999</option>
                <option value="$50,000 - $74,999">$50,000 - $74,999</option>
                <option value="$75,000 - $99,999">$75,000 - $99,999</option>
                <option value="$100,000 - $149,999">$100,000 - $149,999</option>
                <option value="$150,000 - $199,999">$150,000 - $199,999</option>
                <option value="$200,000 or more">$200,000 or more</option>
              </select>
            </div>
          </div>
        </div>

        <div class="field">
            <label class="label">Preferred method for follow-up contact:</label>
             <div class="control">
              <label class="radio">
                <input type="radio" name="contactPreference" value="Email" required> Email
              </label>
              <label class="radio">
                <input type="radio" name="contactPreference" value="Text (SMS)"> Text (SMS)
              </label>
              <label class="radio">
                <input type="radio" name="contactPreference" value="Both Email and Text"> Both Email and Text
              </label>
             </div>
           </div>


        <div class="field">
          <label class="label">How many new vehicles have you purchased in your lifetime?</label>
          <div class="control">
            <input class="input" type="number" name="newVehiclesPurchased" min="0" required>
          </div>
        </div>


        <div class="field">
          <div class="control">
            <button class="button is-primary is-fullwidth" type="submit">Submit Enrollment</button>
          </div>
        </div>
      </form>

      <div class="message-box is-success hidden" id="thankYouMessage">
        <p>Your enrollment has been submitted successfully!</p>
        <p>Thank you for your participation.</p>
      </div>

      <div class="message-box is-danger hidden" id="duplicateMessage">
        </div>

    </div>
  </div>

  <script>
    // Configuration for Google Apps Script Web App URL
    // !!! IMPORTANT: Replace this with your actual Google Apps Script Web App URL !!!
    // Deploy your script (Deploy -> New Deployment -> Web App -> Execute as: Me, Who has access: Anyone, even anonymous)
    // Then copy the "Web app URL" and paste it here.
    const scriptURL = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE";

    // --- Element Selectors ---
    const formCard = document.getElementById('formCard');
    const submissionForm = document.getElementById('submissionForm');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const duplicateMessage = document.getElementById('duplicateMessage');
    const ageCheckSection = document.getElementById('ageCheckSection');
    const purchasePlanSection = document.getElementById('purchasePlanSection');
    const paymentPlanSection = document.getElementById('paymentPlanSection');
    const ageNextBtn = document.getElementById('ageNextBtn');
    const purchaseNextBtn = document.getElementById('purchaseNextBtn');
    const paymentNextBtn = document.getElementById('paymentNextBtn');
    const ageEligibilityMessage = document.getElementById('ageEligibilityMessage');
    const purchaseEligibilityMessage = document.getElementById('purchaseEligibilityMessage');
    const paymentEligibilityMessage = document.getElementById('paymentEligibilityMessage');
    const disqualificationMessage = document.getElementById('disqualificationMessage');
    const restartFormBtn = document.getElementById('restartFormBtn');
    const introExplanationContent = document.getElementById('introExplanationContent');

    // Hidden fields for initial eligibility answers & consent status
    const timestampField = document.getElementById('timestampField');
    const disqualificationReasonField = document.getElementById('disqualificationReasonField');
    const age18OrOverInitialField = document.getElementById('age18OrOverInitialField');
    const purchaseInitialField = document.getElementById('purchaseInitialField');
    const paymentPlanInitialField = document.getElementById('paymentPlanInitialField');
    const consentStatusField = document.getElementById('consentStatusField');
    const viewedWebpageUrlField = document.getElementById('viewedWebpageUrlField');
    const contentCertifiedCheckbox = document.getElementById('contentCertifiedCheckbox');
    const contentCertifiedMessage = document.getElementById('contentCertifiedMessage');
    const contentReviewedBtn = document.getElementById('contentReviewedBtn');

    // Modals
    const consentModal = document.getElementById('consentModal');
    const consentBtn = document.getElementById('consentBtn');
    const declineConsentBtn = document.getElementById('declineConsentBtn');
    const contentModal = document.getElementById('contentModal');
    const webpageIframe = document.getElementById('webpageIframe');
    const surveySection = document.getElementById('submissionForm'); // Renamed from survey-section to submissionForm for consistency

    // NEW: Geolocation elements
    const latitudeField = document.getElementById('latitudeField');
    const longitudeField = document.getElementById('longitudeField');
    const locationAccuracyField = document.getElementById('locationAccuracyField');
    const locationStatusField = document.getElementById('locationStatusField');
    const locationMessage = document.getElementById('locationMessage');

    // NEW: Honeypot field
    const honeypotField = document.getElementById('honeypotField');

    // Timer for content review
    let contentModalStartTime = 0;
    let timeOnContentPageMs = 0;

    // Target URLs for the content modal (replace with actual URLs)
    const targetWebpages = [
        "https://www.edmunds.com/car-buying/",
        "https://www.kbb.com/car-advice/",
        "https://www.consumerreports.org/cars-auto-buying-leasing/"
    ];
    let selectedWebpageUrl = ""; // To store the randomly selected URL

    // --- Helper Functions ---

    // Function to set timestamp
    function setTimestamp() {
      const now = new Date();
      timestampField.value = now.toISOString();
      console.log("Timestamp set:", timestampField.value);
    }

    // Function to fetch client IP address
    async function fetchClientIp() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            clientFetchedIpField.value = data.ip;
            console.log('Client IP fetched:', data.ip);
        } catch (error) {
            console.error('Error fetching client IP:', error);
            clientFetchedIpField.value = 'N/A_ClientFetch_Failed';
        }
    }

    // NEW: Function to get user's geolocation
    function getLocation() {
        if (navigator.geolocation) {
            locationMessage.textContent = 'Please allow location access to continue.';
            locationMessage.classList.add('is-info'); // Add info styling
            locationMessage.classList.remove('is-danger', 'has-text-success'); // Remove any previous error/success styling

            // Set a timeout for the geolocation request
            const geoTimeout = setTimeout(() => {
                locationMessage.textContent = 'Location request timed out. You can proceed without location.';
                locationMessage.classList.remove('is-info', 'has-text-success');
                locationMessage.classList.add('is-danger');
                locationStatusField.value = 'Timeout';
            }, 10000); // 10 seconds timeout

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    clearTimeout(geoTimeout); // Clear the timeout if successful
                    latitudeField.value = position.coords.latitude;
                    longitudeField.value = position.coords.longitude;
                    locationAccuracyField.value = position.coords.accuracy;
                    locationStatusField.value = 'Granted';
                    locationMessage.textContent = 'Location acquired. Thank you!';
                    locationMessage.classList.remove('is-info', 'is-danger');
                    locationMessage.classList.add('has-text-success'); // Indicate success visually
                    console.log('Geolocation granted:', position.coords);
                },
                (error) => {
                    clearTimeout(geoTimeout); // Clear the timeout if an error occurs
                    let status = 'Denied';
                    let errorMessage = 'Location access denied by user. You can proceed without location.';
                    if (error.code === error.PERMISSION_DENIED) {
                        status = 'Denied';
                        errorMessage = 'Location access denied by user. You can proceed without location.';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        status = 'Unavailable';
                        errorMessage = 'Location information is unavailable. You can proceed without location.';
                    } else if (error.code === error.TIMEOUT) {
                        status = 'Timeout';
                        errorMessage = 'Location request timed out. You can proceed without location.';
                    }
                    latitudeField.value = 'N/A';
                    longitudeField.value = 'N/A';
                    locationAccuracyField.value = 'N/A';
                    locationStatusField.value = status;
                    locationMessage.textContent = errorMessage;
                    locationMessage.classList.remove('is-info', 'has-text-success');
                    locationMessage.classList.add('is-danger');
                    console.error('Geolocation error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 seconds to get the location
                    maximumAge: 0 // Do not use a cached position
                }
            );
        } else {
            latitudeField.value = 'N/A';
            longitudeField.value = 'N/A';
            locationAccuracyField.value = 'N/A';
            locationStatusField.value = 'Unsupported';
            locationMessage.textContent = 'Geolocation is not supported by your browser. You can proceed without location.';
            locationMessage.classList.remove('is-info', 'has-text-success');
            locationMessage.classList.add('is-danger');
            console.warn('Geolocation is not supported by this browser.');
        }
    }

    // Function to handle disqualification
    function disqualifyUser(reason) {
        formCard.classList.add("hidden");
        ageCheckSection.classList.add("hidden");
        purchasePlanSection.classList.add("hidden");
        paymentPlanSection.classList.add("hidden");
        introExplanationContent.classList.add("hidden");
        submissionForm.classList.add("hidden");
        thankYouMessage.classList.add("hidden");
        duplicateMessage.classList.add("hidden"); // Hide other messages

        disqualificationMessage.classList.remove("hidden");
        disqualificationReasonField.value = reason; // Set the disqualification reason
        consentStatusField.value = 'Disqualified'; // Update consent status if disqualified before consent
        setTimestamp(); // Set timestamp on disqualification
        console.log("User disqualified:", reason);
    }

    // Function to reset the form for a new attempt
    function resetForm() {
        submissionForm.reset();
        // Reset hidden fields
        timestampField.value = '';
        disqualificationReasonField.value = 'Not Disqualified';
        age18OrOverInitialField.value = '';
        purchaseInitialField.value = '';
        paymentPlanInitialField.value = '';
        consentStatusField.value = 'No Consent';
        viewedWebpageUrlField.value = '';
        timeOnContentPageMsField.value = '0';
        clientFetchedIpField.value = 'N/A_ClientFetch_Skipped'; // Reset IP
        honeypotField.value = ''; // Reset honeypot
        latitudeField.value = 'N/A';
        longitudeField.value = 'N/A';
        locationAccuracyField.value = 'N/A';
        locationStatusField.value = 'Pending';
        locationMessage.textContent = 'Attempting to get your location for research purposes...';
        locationMessage.classList.remove('is-danger', 'has-text-success');
        locationMessage.classList.add('is-info');


        // Hide all sections except the initial age check
        disqualificationMessage.classList.add("hidden");
        thankYouMessage.classList.add("hidden");
        duplicateMessage.classList.add("hidden");
        purchasePlanSection.classList.add("hidden");
        paymentPlanSection.classList.add("hidden");
        submissionForm.classList.add("hidden");
        consentModal.classList.remove("is-active"); // Hide modal if open
        contentModal.classList.remove("is-active"); // Hide modal if open

        // Show initial sections
        formCard.classList.remove("hidden");
        ageCheckSection.classList.remove("hidden");
        introExplanationContent.classList.remove("hidden");

        // Re-fetch IP and prepare for location request
        fetchClientIp();
    }


    // --- Event Listeners ---

    // Event Listener for Age Check "Next" Button
    ageNextBtn.addEventListener("click", function () {
        const age18OrOver = document.querySelector('input[name="age18OrOver"]:checked');
        if (!age18OrOver) {
            ageEligibilityMessage.textContent = "Please select an option.";
            ageEligibilityMessage.style.display = "block";
            return;
        } else {
            ageEligibilityMessage.style.display = "none";
        }

        age18OrOverInitialField.value = age18OrOver.value; // Store initial answer

        if (age18OrOver.value === "No") {
            disqualifyUser("Age less than 18");
        } else {
            ageCheckSection.classList.add("hidden");
            purchasePlanSection.classList.remove("hidden");
            introExplanationContent.classList.remove("hidden"); // Keep intro visible
        }
    });

    // Event Listener for Purchase Plan "Next" Button
    purchaseNextBtn.addEventListener("click", function () {
        const purchasePlan = document.querySelector('input[name="purchasePlan"]:checked');
        if (!purchasePlan) {
            purchaseEligibilityMessage.textContent = "Please select an option.";
            purchaseEligibilityMessage.style.display = "block";
            return;
        } else {
            purchaseEligibilityMessage.style.display = "none";
        }

        purchaseInitialField.value = purchasePlan.value; // Store initial answer

        if (purchasePlan.value === "No") {
            disqualifyUser("Not planning car purchase");
        } else {
            purchasePlanSection.classList.add("hidden");
            paymentPlanSection.classList.remove("hidden");
            introExplanationContent.classList.remove("hidden"); // Keep intro visible
        }
    });

    // Event Listener for Payment Plan "Continue" Button (last eligibility check)
    paymentNextBtn.addEventListener("click", function () {
        const paymentPlan = document.querySelector('input[name="paymentPlan"]:checked');
        if (!paymentPlan) {
            paymentEligibilityMessage.textContent = "Please select an option.";
            paymentEligibilityMessage.style.display = "block";
            return;
        } else {
            paymentEligibilityMessage.style.display = "none";
        }

        paymentPlanInitialField.value = paymentPlan.value; // Store initial answer

        if (paymentPlan.value !== "Finance" && paymentPlan.value !== "Lease" && paymentPlan.value !== "Cash") {
            disqualifyUser("Payment plan not suitable");
        } else {
            // If all eligibility checks pass, show Consent Modal
            paymentPlanSection.classList.add("hidden");
            introExplanationContent.classList.add("hidden"); // Hide intro once eligible for consent
            consentModal.classList.add("is-active"); // Show Consent Modal
            setTimestamp(); // Set timestamp for eligible participants before consent
        }
    });

    // Event Listener for Consent Button (inside Consent Modal)
    consentBtn.addEventListener("click", function() {
      consentStatusField.value = 'Consented'; // Update hidden field
      consentModal.classList.remove("is-active");

      // Randomly select a webpage for review
      const randomIndex = Math.floor(Math.random() * targetWebpages.length);
      selectedWebpageUrl = targetWebpages[randomIndex];
      viewedWebpageUrlField.value = selectedWebpageUrl; // Update hidden field with the URL that will be shown

      webpageIframe.src = selectedWebpageUrl;
      contentModal.classList.remove("hidden"); // Ensure content modal is not hidden by CSS
      contentModal.classList.add("is-active"); // Show the content modal

      contentModalStartTime = new Date().getTime(); // Start timer for content review
      console.log('Consent given. Now opening content modal. Timer started.');

      // Hide other sections if needed, but the modal overlays them
      formCard.classList.remove("hidden"); // Ensure form card is visible behind modal
      surveySection.classList.add("hidden"); // Keep demographics hidden until content review
    });


    // Event Listener for Decline Consent Button (inside Consent Modal)
    declineConsentBtn.addEventListener("click", function() {
        consentStatusField.value = 'Declined Consent';
        disqualifyUser("Declined Consent");
        consentModal.classList.remove("is-active"); // Hide consent modal
    });

    // Event Listener for "Content Reviewed" button
    contentReviewedBtn.addEventListener('click', function() {
        if (!contentCertifiedCheckbox.checked) {
            contentCertifiedMessage.classList.remove('hidden'); // Show error message
            return; // Prevent proceeding
        } else {
            contentCertifiedMessage.classList.add('hidden'); // Hide error message
        }

        const endTime = new Date().getTime();
        timeOnContentPageMs = endTime - contentModalStartTime;
        timeOnContentPageMsField.value = timeOnContentPageMs; // Update hidden field
        contentCertifiedCheckbox.value = 'Yes'; // Mark as certified

        contentModal.classList.remove("is-active"); // Hide content modal
        surveySection.classList.remove("hidden"); // Show demographics form
        formCard.classList.remove("hidden"); // Ensure the main form card is visible again

        getLocation(); // Request geolocation when demographics section is shown
        console.log('Content certified. Time on page:', timeOnContentPageMs, 'ms. Showing demographics.');
    });


    // Event Listener for Restart Form Button
    restartFormBtn.addEventListener("click", resetForm);

    // --- Form Submission Handler ---
    submissionForm.addEventListener("submit", async function (e) {
      e.preventDefault(); // Prevent default form submission

      // Hide existing messages
      thankYouMessage.classList.add("hidden");
      duplicateMessage.classList.add("hidden");
      disqualificationMessage.classList.add("hidden"); // Ensure disqualification message is hidden

      // Collect all form data including hidden fields
      const formData = new FormData(submissionForm);
      // For race, convert multiple checkboxes to a comma-separated string
      const raceCheckboxes = document.querySelectorAll('input[name="race"]:checked');
      if (raceCheckboxes.length > 0) {
        const selectedRaces = Array.from(raceCheckboxes).map(cb => cb.value).join(', ');
        formData.set("race", selectedRaces);
      } else {
        formData.set("race", "Not Provided"); // Or whatever default you prefer if none selected
      }

      // Convert FormData to a URL-encoded string for Google Apps Script
      const params = new URLSearchParams(formData).toString();
      console.log("Submitting form data:", params); // Log parameters for debugging

      try {
          const response = await fetch(scriptURL, {
              method: "POST",
              headers: {
                  "Content-Type": "application/x-www-form-urlencoded"
              },
              body: params,
              mode: 'cors' // Ensure CORS mode
          });

          // Check if the response is OK (status 200-299)
          if (!response.ok) {
              const errorText = await response.text(); // Get raw error text from server
              throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
          }

          const result = await response.json(); // Parse response as JSON

          if (result.status === "success") {
              submissionForm.classList.add("hidden");
              formCard.classList.add("hidden"); // Hide the entire form card
              thankYouMessage.classList.remove("hidden"); // Show success message
              console.log('Submission successful:', result.message);
          } else {
              submissionForm.classList.add("hidden");
              formCard.classList.add("hidden"); // Hide the entire form card
              duplicateMessage.classList.remove("hidden"); // Show error message
              duplicateMessage.innerHTML = `<p>${result.message}</p>`; // Display specific error from script
              console.warn('Submission failed (script error):', result.message);
          }
      } catch (error) {
          console.error('Final Fetch or Script Error:', error);
          // Display a custom error message for network/fetch errors
          duplicateMessage.classList.remove('hidden');
          duplicateMessage.innerHTML = '<p>There was a network error during submission. Please check your internet connection and try again.</p><button class="button is-small is-danger mt-3" id="restartFormBtn">Restart Form</button>';
          // Attach event listener to new restart button if network error occurs
          document.getElementById('restartFormBtn').addEventListener('click', resetForm);
          submissionForm.classList.add("hidden"); // Hide submission form
          formCard.classList.add("hidden"); // Hide the entire form card
          thankYouMessage.classList.add("hidden"); // Ensure success message is hidden
      }
    });


    // --- Initial Page Load Setup ---
    document.addEventListener("DOMContentLoaded", function () {
        // Ensure only the first eligibility question is visible initially
        ageCheckSection.classList.remove("hidden");
        introExplanationContent.classList.remove("hidden");
        purchasePlanSection.classList.add("hidden");
        paymentPlanSection.classList.add("hidden");
        surveySection.classList.add("hidden"); // Ensure demographics is hidden
        formCard.classList.remove("hidden"); // Ensure the form card is visible
        consentModal.classList.add("hidden"); // Ensure modals are hidden
        contentModal.classList.add("hidden"); // Ensure modals are hidden

        // Fetch IP address on page load
        fetchClientIp();
    });

  </script>

</body>
</html>
