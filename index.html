<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enrollment Form: Car Buying Study</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <style>
    :root {
      --dartmouth-green: #00693e;
      --forest-green: #228B22;
      --off-white: #f8f8f8;
    }

    body {
      background-color: var(--off-white);
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .form-card {
      max-width: 700px;
      margin: 20px auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 10px;
      overflow: hidden;
    }
    .hidden {
      display: none;
    }
    .message-box {
      margin: 20px auto;
      max-width: 600px;
      padding: 20px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
    }

    .message-box.is-danger {
       background-color: #f8d7da;
       color: #721c24;
       border-color: #f5c6cb;
    }

    .hero.is-primary.is-bold {
      background-color: var(--dartmouth-green);
      background-image: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .hero-body .container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero .title {
      color: white;
      font-size: 2.5em;
      font-weight: 600;
      margin-left: 1.5rem;
      margin-bottom: 0;
    }

    .banner-logo {
      max-height: 70px;
      width: auto;
    }

    .button.is-primary {
      background-color: var(--dartmouth-green);
      border-color: var(--dartmouth-green);
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .button.is-primary:hover,
    .button.is-primary:focus {
      background-color: #005a34;
      border-color: #005a34;
    }

    .button.is-success {
      background-color: var(--forest-green);
      border-color: var(--forest-green);
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .button.is-success:hover,
    .button.is-success:focus {
      background-color: #1e7d1e;
      border-color: #1e7d1e;
    }

    .label {
      font-weight: 600;
      color: #363636;
      margin-bottom: 0.75rem;
    }
    .field {
      margin-bottom: 1.5rem;
    }

    .input, .select select {
      border-color: #dbdbdb;
      box-shadow: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input:focus, .select select:focus, .textarea:focus {
      border-color: var(--forest-green);
      box-shadow: 0 0 0 0.125em rgba(34, 139, 34, 0.25);
    }

    .radio {
      margin-right: 1.5em;
      cursor: pointer;
    }

    .content p {
      line-height: 1.7;
      margin-bottom: 1em;
    }
    .content hr {
      background-color: #eee;
      height: 1px;
      margin: 2rem 0;
    }


    .modal-content {
      width: 95%;
      max-width: 1600px;
      height: 95%;
      max-height: 1200px;
      display: flex;
      flex-direction: column;
    }

    .modal-content .box {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      position: relative;
    }


    .iframe-container {
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      background-color: white;
    }

    .modal-content iframe {
      display: block;
      width: 100%;
      min-height: 100%;
      border: none;
    }

    .sticky-footer {
        position: sticky;
        bottom: 0;
        left: -20px;
        width: calc(100% + 40px);
        background-color: white;
        padding: 15px 20px;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 10;

        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .sticky-footer .confirm-text {
        margin-bottom: 10px !important;
        text-align: center;
        font-size: 0.9em;
    }

    .sticky-footer .control {
        width: 100%;
        text-align: center;
    }


    .modal .modal-close {
        top: 10px;
        right: 10px;
    }


    .help.is-danger {
        color: #f14668;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }


    @media (max-width: 768px) {
      .hero .title {
           font-size: 1.8em;
           margin-left: 1rem;
      }
       .hero-body .container {
           flex-direction: column;
           text-align: center;
      }
      .banner-logo {
           margin-bottom: 10px;
      }
      .hero .title {
           margin-left: 0;
      }
      .modal-content {
           width: 95%;
           height: 95%;
      }
       .modal-content .box {
         padding: 15px;
       }
        .sticky-footer {
            left: -15px;
            width: calc(100% + 30px);
            padding: 10px 15px;
        }
         .modal .modal-close {
             top: 5px;
             right: 5px;
         }
    }
  </style>
</head>
<body>

  <section class="hero is-primary is-bold">
    <div class="hero-body">
      <div class="container">
        <img src="D-Pine_Rev.png" alt="Dartmouth College Logo" class="banner-logo">
        <h1 class="title">Enrollment Form: Car Buying Study</h1>
      </div>
    </div>
  </section>

  <div class="card form-card" id="form-card">
    <div class="card-content">

      <div id="intro-explanation-content" class="content">
        <h2></h2>
        <p>Researchers at Dartmouth College are collecting information on car purchases and would like to pay YOU for your help.</p>
        <p>Answer just three questions to find out if you qualify to receive:</p>
        <ul>
          <li>$5 for completing a very short survey</li>
          <li>$20 for texting or emailing us readable pictures with the details of your car purchase and financing details.</li>
        </ul>
        <p>Your responses will be kept confidential and used for research purposes only.</p>
        <hr>
      </div>

      <form id="purchaseForm">
        <input type="hidden" name="timestamp" id="timestampField">
        <input type="hidden" name="consentStatus" id="consentStatusField" value="Not Applicable">
        <input type="hidden" name="viewedWebpageUrl" id="viewedWebpageUrlField" value="N/A">
        <input type="hidden" name="contentCertified" id="contentCertifiedField" value="No">
        <input type="hidden" name="timeOnContentPageMs" id="timeOnContentPageMsField" value="0">
        <input type="hidden" name="clientFetchedIp" id="clientFetchedIpField" value="N/A_ClientFetch_Skipped">

        
        <div class="field hidden">
          <label class="label" for="honeypotField">Leave this field empty</label>
          <div class="control">
            <input class="input" type="text" name="honeypot" id="honeypotField" tabindex="-1" autocomplete="off">
          </div>
        </div>

        <div id="age-check-section">
           <div class="field">
            <label class="label">Are you 18 years of age or older?</label>
             <div class="control">
              <label class="radio">
                <input type="radio" name="age18OrOverInitial" value="Yes" required> Yes
              </label>
              <label class="radio">
                <input type="radio" name="age18OrOverInitial" value="No" required> No
              </label>
             </div>
           </div>
           <p class="help is-danger hidden" id="age18OrOverInitialError"></p>
           <button class="button is-primary" type="button" id="ageNextBtn">Next</button>
        </div>

        <div id="purchase-plan-section" class="hidden">
           <div class="field">
                <label class="label">What are your vehicle purchase plans?</label>
                <div class="control">
                <label class="radio">
                    <input type="radio" name="purchaseInitial" value="Will buy new car within 1 month" required>
                    Will probably buy a new car within the next month
                </label><br>
                <label class="radio">
                    <input type="radio" name="purchaseInitial" value="Will buy used car within 1 month">
                    Will probably buy a used car within the next month
                </label><br>
                <label class="radio">
                    <input type="radio" name="purchaseInitial" value="No plans to buy car within 1 month">
                    No plans to buy a car within the next month
                </label>
                </div>
            </div>
            <p class="help is-danger hidden" id="purchaseInitialError"></p>
            <button class="button is-primary" type="button" id="purchaseNextBtn">Next</button>
        </div>

        <div id="payment-plan-section" class="hidden">
            <div class="field">
                <label class="label">How do you plan to pay for your car?</label>
                <div class="control">
                    <label class="radio">
                        <input type="radio" name="paymentPlanInitial" value="All cash" required> All cash
                    </label><br>
                    <label class="radio">
                        <input type="radio" name="paymentPlanInitial" value="At least some financing"> At least some financing
                    </label>
                </div>
            </div>
            <p class="help is-danger hidden" id="paymentPlanInitialError"></p>
            <button class="button is-primary" type="button" id="paymentNextBtn">Continue</button>
        </div>


        <div id="survey-section" class="hidden">
          <hr>
          <h3 class="title is-5">Contact & Demographic Information</h3>

          <div class="field">
            <label class="label">Full Name</label>
            <input class="input" type="text" name="fullName" required>
          </div>

          <div class="field">
            <label class="label">Email</label>
            <input class="input" type="email" name="email" required>
          </div>

           <div class="field">
            <label class="label">Phone Number</label>
            <input class="input" type="tel" name="phoneNumber" required>
             <p class="help is-danger hidden" id="phoneNumberError"></p>
           </div>


          <div class="field">
            <label class="label">Age</label>
            <input class="input" type="number" name="age" min="18" max="99" required>
             <p class="help is-danger hidden" id="ageError"></p>
          </div>

          <div class="field">
            <label class="label">Gender</label>
            <div class="control">
              <label class="radio"><input type="radio" name="gender" value="Male" required> Male</label>
              <label class="radio"><input type="radio" name="gender" value="Female"> Female</label>
              <label class="radio"><input type="radio" name="gender" value="Other"> Other</label>
            </div>
          </div>

          <div class="field">
            <label class="label">Race</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select name="race" required>
                  <option value="">Select your race</option>
                  <option value="White">White</option>
                  <option value="Black or African American">Black or African American</option>
                  <option value="American Indian or Alaska Native">American Indian or Alaska Native</option>
                  <option value="Asian">Asian</option>
                  <option value="Native Hawaiian or Other Pacific Islander">Native Hawaiian or Other Pacific Islander</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label">Are you Hispanic or Latino?</label>
            <div class="control">
              <label class="radio"><input type="radio" name="hispanic" value="Yes" required> Yes</label>
              <label class="radio"><input type="radio" name="hispanic" value="No"> No</label>
            </div>
          </div>

          <div class="field">
            <label class="label">Highest Level of Education</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select name="education" required>
                  <option value="">Select education level</option>
                  <option value="Some high school">Some high school</option>
                  <option value="High school">High school</option>
                  <option value="Some college">Some college</option>
                  <option value="Associate’s degree">Associate’s degree</option>
                  <option value="Bachelor’s degree">Bachelor’s degree</option>
                  <option value="Graduate degree">Graduate degree</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
             <label class="label">Occupation / Industry Role</label>
             <div class="control">
              <div class="select is-fullwidth">
               <select name="occupation" required>
                 <option value="">Select your occupation</option>
                  <option value="11-0000">Management Occupations</option>
                  <option value="13-0000">Business and Financial Operations Occupations</option>
                  <option value="15-0000">Computer and Mathematical Occupations</option>
                  <option value="17-0000">Architecture and Engineering Occupations</option>
                  <option value="19-0000">Life, Physical, and Social Science Occupations</option>
                  <option value="21-0000">Community and Social Service Occupations</option>
                  <option value="23-0000">Legal Occupations</option>
                  <option value="25-0000">Educational Instruction and Library Occupations</option>
                  <option value="27-0000">Arts, Design, Entertainment, Sports, and Media Occupations</option>
                  <option value="29-0000">Healthcare Practitioners and Technical Occupations</option>
                  <option value="31-0000">Healthcare Support Occupations</option>
                  <option value="33-0000">Protective Service Occupations</option>
                  <option value="35-0000">Food Preparation and Serving Related Occupations</option>
                  <option value="37-0000">Building and Grounds Cleaning and Maintenance Occupations</option>
                  <option value="39-0000">Personal Care and Service Occupations</option>
                  <option value="41-0000">Sales and Related Occupations</option>
                  <option value="43-0000">Office and Administrative Support Occupations</option>
                  <option value="45-0000">Farming, Fishing, and Forestry Occupations</option>
                  <option value="47-0000">Construction and Extraction Occupations</option>
                  <option value="49-0000">Installation, Maintenance, and Repair Occupations</option>
                  <option value="51-0000">Production Occupations</option>
                  <option value="53-0000">Transportation and Material Moving Occupations</option>
                  <option value="55-0000">Military Specific Occupations</option>
                  <option value="Student">Student</option>
                  <option value="Unemployed">Unemployed</option>
                  <option value="Retired">Retired</option>
                  <option value="Other">Other</option>
               </select>
              </div>
             </div>
           </div>

           <div class="field">
               <label class="label">Household Income</label>
               <div class="control">
                   <div class="select is-fullwidth">
                       <select name="householdIncome" required>
                           <option value="">Select your household income</option>
                           <option value="Under $15,000">Under $15,000</option>
                           <option value="$15,000 - $24,999">$15,000 - $24,999</option>
                           <option value="$25,000 - $34,999">$25,000 - $34,999</option>
                           <option value="$35,000 - $49,999">$35,000 - $49,999</option>
                           <option value="$50,000 - $74,999">$50,000 - $74,999</option>
                           <option value="$75,000 - $99,999">$74,999 - $99,999</option>
                           <option value="$100,000 - $149,999">$100,000 - $149,999</option>
                           <option value="$150,000 - $199,999">$150,000 - $199,999</option>
                           <option value="$200,000 or more">$200,000 or more</option>
                       </select>
                   </div>
               </div>
           </div>


           <div class="field">
             <label class="label">Preferred method for follow-up contact:</label>
              <div class="control">
               <label class="radio">
                 <input type="radio" name="contactPreference" value="Email" required> Email
               </label>
               <label class="radio">
                 <input type="radio" name="contactPreference" value="Text (SMS)"> Text (SMS)
               </label>
               <label class="radio">
                 <input type="radio" name="contactPreference" value="Both Email and Text"> Both Email and Text
               </label>
              </div>
            </div>

          <input type="hidden" name="latitude" id="latitudeField" value="N/A">
          <input type="hidden" name="longitude" id="longitudeField" value="N/A">
          <input type="hidden" name="locationAccuracy" id="locationAccuracyField" value="N/A">
          <input type="hidden" name="locationStatus" id="locationStatusField" value="Pending">

          <div class="field">
              <p class="help is-info" id="locationMessage">Attempting to get your location for research purposes...</p>
          </div>
          <div class="field">
            <label class="label">How many new vehicles have you purchased in your lifetime?</label>
            <input class="input" type="number" name="newVehiclesPurchased" min="0" required>
          </div>
          
          <div class="field">
            <button class="button is-success" type="submit" id="demographicsSubmitBtn">Submit Enrollment</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="thank-you" class="message-box hidden">
    <p class="title is-5 has-text-success">Thank you for completing the initial enrollment.</p>
    <p>Please look out for an email with further instructions.</p>
  </div>


  <div id="duplicate-message" class="message-box is-danger hidden"></div>

  <div id="consent-required-message" class="message-box is-danger hidden">
    <p class="title is-5 has-text-danger">Consent Required</p>
    <p>To participate in this study and proceed with the enrollment form, you must provide your consent.</p>
    <button class="button is-primary mt-4" id="reopenConsentBtn">Review Consent Form</button>
  </div>

  <div id="content-required-message" class="message-box is-danger hidden">
    <p class="title is-5 has-text-danger">Content Review Required</p>
    <p>You must review the provided content to proceed with the study.</p>
    <button class="button is-primary mt-4" id="reopenContentBtn">Review Content</button>
  </div>


  <div id="consent-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box">
        <h3 class="title is-4">Consent Form</h3>
        <p>Please review the consent form below:</p>
        <div class="pdf-viewer-container" style="flex-grow: 1; min-height: 300px; position: relative; margin-bottom: 20px;">
          <iframe src="expedited-consent-template_05_19_2025.pdf" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0"></iframe>
        </div>
        <div class="sticky-footer"> <p class="confirm-text">By clicking the "Consent" button below, you are indicating that I have read the above information about the Car Buying Study and have been given time to ask questions. I agree to take part in this study and I will be given a copy of this signed consent form.</p>
          <p class="control">
            <button class="button is-success" id="consentBtn">Consent</button>
          </p>
        </div>
      </div>
    </div>
    <button class="modal-close is-large" aria-label="close" id="closeConsentModal"></button>
  </div>

  <div id="content-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box">
        <h3 class="title is-4">Review Required Content</h3>
           <div class="iframe-container">
             <iframe id="webpageIframe" src="" frameborder="0"></iframe>
          </div>
        <div class="sticky-footer"> <p class="confirm-text">By clicking "I Certify...", you confirm that you have reviewed the content shown above.</p>
          <p class="control">
            <button class="button is-success" id="certifyBtn">I certify that I have reviewed this content</button>
          </p>
        </div>
      </div>
    </div>
       <button class="modal-close is-large" aria-label="close" id="closeContentModal"></button>
  </div>


     <script>
    // !!! REPLACE with your actual Google Apps Script Web App URL for this study data submission !!!
    const scriptURL = "https://script.google.com/macros/s/AKfycbzR0R21CHTJvYXI5mOwIkIV3kVQSa9AC0dby7Hv4J6ODXRCgJ-1XYbh_R7tKGECykly/exec";

    const timestampField = document.getElementById("timestampField");
    const form = document.getElementById("purchaseForm");
    const thankYouMessage = document.getElementById("thank-you");
    const duplicateMessage = document.getElementById("duplicate-message");
    const formCard = document.getElementById("form-card");
    const introExplanationContent = document.getElementById("intro-explanation-content");

    // Elements for initial screening (now sequential)
    const ageCheckSection = document.getElementById("age-check-section");
    const purchasePlanSection = document.getElementById("purchase-plan-section");
    const paymentPlanSection = document.getElementById("payment-plan-section");

    const ageNextBtn = document.getElementById("ageNextBtn");
    const purchaseNextBtn = document.getElementById("purchaseNextBtn");
    const paymentNextBtn = document.getElementById("paymentNextBtn");
    const demographicsSubmitBtn = document.getElementById("demographicsSubmitBtn"); // New reference to demographics submit button

    const age18OrOverInitialError = document.getElementById('age18OrOverInitialError');
    const purchaseInitialError = document.getElementById('purchaseInitialError');
    const paymentPlanInitialError = document.getElementById('paymentPlanInitialError');

    // Elements for survey section (Demographics)
    const surveySection = document.getElementById("survey-section");

    // Consent modal elements
    const consentModal = document.getElementById("consent-modal");
    const consentBtn = document.getElementById("consentBtn");
    const closeConsentModal = document.getElementById("closeConsentModal");

    // Content modal elements
    const contentModal = document.getElementById("content-modal");
    const webpageIframe = document.getElementById("webpageIframe");
    const certifyBtn = document.getElementById("certifyBtn");
    const closeContentModal = document.getElementById("closeContentModal");

    // Hidden form fields
    const consentStatusField = document.getElementById("consentStatusField");
    const viewedWebpageUrlField = document.getElementById("viewedWebpageUrlField");
    const contentCertifiedField = document.getElementById("contentCertifiedField");
    const timeOnContentPageMsField = document.getElementById("timeOnContentPageMsField");
    const clientFetchedIpField = document.getElementById('clientFetchedIpField');

    // Bot protection field
    const honeypotField = document.getElementById('honeypotField');

    // Validation error elements for the *main survey* fields
    const phoneNumberError = document.getElementById('phoneNumberError');
    const ageError = document.getElementById('ageError');

    // Consent Required Message elements
    const consentRequiredMessage = document.getElementById('consent-required-message');
    const reopenConsentBtn = document.getElementById('reopenConsentBtn');

    // Content Required Message elements
    const contentRequiredMessage = document.getElementById('content-required-message');
    const reopenContentBtn = document.getElementById('reopenContentBtn');

    const latitudeField = document.getElementById('latitudeField');
    const longitudeField = document.getElementById('longitudeField');
    const locationAccuracyField = document.getElementById('locationAccuracyField');
    const locationStatusField = document.getElementById('locationStatusField');
    const locationMessage = document.getElementById('locationMessage');
       
    // Array of target webpages for the content modal
    const targetWebpages = [
        "Treatment content.pdf",
        "Treatment content.pdf",
        "Treatment content.pdf"
    ];

    // NEW: Array of URLs for random redirection after successful submission
    const postSubmissionRedirectUrls = [
        "https://www.google.com/", // Example URL 1
        "https://www.bing.com/",   // Example URL 2
        "https://www.yahoo.com/"   // Example URL 3
        // Add more URLs as needed
    ];

    let selectedWebpageUrl = null; // Store the chosen URL for the content modal
    let contentModalStartTime = null; // Used for time tracking in content modal
    let currentFormData = null; // To store form data temporarily before final submission


    /*
    // !!! TEMPORARILY DISABLED FOR TESTING !!!
    if (localStorage.getItem('carStudyCompleted')) {
      console.log('Local Storage flag found: Survey already completed in this browser.');
      formCard.classList.add('hidden');
      duplicateMessage.classList.remove('hidden');
      duplicateMessage.innerHTML = '<p>Thank you for your participation. Our records indicate that you have already completed this survey using this browser.</p>';
      thankYouMessage.classList.add('hidden');

        ageNextBtn.disabled = true; // Disable initial next button
        demographicsSubmitBtn.disabled = true; // Disable demographics submit button
    } else {
        setTimestamp();
        console.log('No Local Storage flag found. Setting initial timestamp.');
    }
    // !!! TO RE-ENABLE, UNCOMMENT THE ABOVE BLOCK AND REMOVE THIS COMMENT BLOCK !!!
    */

      // If Local Storage check is disabled, ensure timestamp is set on load
      if (!localStorage.getItem('carStudyCompleted')) {
          setTimestamp();
          console.log('Local Storage check disabled. Setting initial timestamp.');
      }

    // Call fetchClientIp on page load to start the process early.
    // This gives the asynchronous IP fetch time to complete while the user fills out the form.
    document.addEventListener('DOMContentLoaded', fetchClientIp);


    function setTimestamp() {
      const now = new Date();
      const timestampString = now.getFullYear() + '-' +
                               ('0' + (now.getMonth() + 1)).slice(-2) + '-' +
                               ('0' + now.getDate()).slice(-2) + ' ' +
                               ('0' + now.getHours()).slice(-2) + ':' +
                               ('0' + now.getMinutes()).slice(-2) + ':' +
                               ('0' + now.getSeconds()).slice(-2);
      timestampField.value = timestampString;
    }


    function formatFormData(formData) {
        const params = new URLSearchParams();
        for (const pair of formData.entries()) {
            params.append(pair[0], pair[1]);
        }
        return params.toString();
    }


    function recordContentModalTime() {
        if (contentModalStartTime !== null) {
            const now = new Date().getTime();
            const duration = now - contentModalStartTime;
            timeOnContentPageMsField.value = duration;
            console.log(`Time on content modal: ${duration} ms`);
            contentModalStartTime = null;
        }
    }

   function getLocation() {
        if (navigator.geolocation) {
            // Keep the initial request message friendly
            locationMessage.textContent = 'Requesting your location. This is required for study participation and helps us understand regional differences.';
            locationMessage.classList.remove('is-danger', 'has-text-success');
            locationMessage.classList.add('is-info'); 

            const geoTimeout = setTimeout(() => {
                locationMessage.textContent = 'Location request timed out. Location is required to participate. Please refresh or check browser/OS settings.';
                locationMessage.classList.remove('is-info', 'has-text-success');
                locationMessage.classList.add('is-danger');
                locationStatusField.value = 'Timeout_Form'; // Custom status for our timeout
                latitudeField.value = 'N/A';
                longitudeField.value = 'N/A';
                locationAccuracyField.value = 'N/A';
            }, 15000); // 15 seconds timeout

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    clearTimeout(geoTimeout); 
                    latitudeField.value = position.coords.latitude;
                    longitudeField.value = position.coords.longitude;
                    locationAccuracyField.value = position.coords.accuracy;
                    locationStatusField.value = 'Granted';
                    locationMessage.textContent = 'Location acquired. Thank you!';
                    locationMessage.classList.remove('is-info', 'is-danger');
                    locationMessage.classList.add('has-text-success'); 
                    console.log('Geolocation granted:', position.coords);
                },
                (error) => {
                    clearTimeout(geoTimeout); 
                    let status = 'Denied_Unknown'; 
                    let errorMessage = 'Could not retrieve location. Location is required to participate. Please check browser/OS settings.'; // Default error
                    
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            status = 'Denied_User';
                            // *** MODIFIED MESSAGE ***
                            errorMessage = 'Location access denied by user. Location is required to participate. You may need to adjust browser settings and refresh.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            status = 'Unavailable';
                            // *** MODIFIED MESSAGE ***
                            errorMessage = 'Location information is unavailable. Location is required to participate. Ensure location services are enabled.';
                            break;
                        case error.TIMEOUT:
                            status = 'Timeout_API'; 
                            // *** MODIFIED MESSAGE ***
                            errorMessage = 'Location request timed out (API). Location is required to participate. Please try again or check settings.';
                            break;
                    }
                    
                    latitudeField.value = 'N/A';
                    longitudeField.value = 'N/A';
                    locationAccuracyField.value = 'N/A';
                    locationStatusField.value = status;
                    locationMessage.textContent = errorMessage;
                    locationMessage.classList.remove('is-info', 'has-text-success');
                    locationMessage.classList.add('is-danger');
                    console.error('Geolocation error:', error.message, '(Code:', error.code, ')');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000, 
                    maximumAge: 0 
                }
            );
        } else {
            latitudeField.value = 'N/A';
            longitudeField.value = 'N/A';
            locationAccuracyField.value = 'N/A';
            locationStatusField.value = 'Unsupported';
            // *** MODIFIED MESSAGE ***
            locationMessage.textContent = 'Geolocation is not supported by your browser. Location is required to participate.';
            locationMessage.classList.remove('is-info', 'has-text-success');
            locationMessage.classList.add('is-danger');
            console.warn('Geolocation is not supported by this browser.');
        }
    }

    async function fetchClientIp() {
        const ipServices = [
           'https://api64.ipify.org?format=json', 
           'https://jsonip.com/'                  
        ];

        let clientIp = 'N/A_ClientFetch_Failed'; 

        for (const serviceUrl of ipServices) {
            try {
                console.log('Attempting to fetch IP from:', serviceUrl);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); 

                const response = await fetch(serviceUrl, { signal: controller.signal });
                clearTimeout(timeoutId); 

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.ip) {
                        clientIp = data.ip;
                        console.log("Client-fetched IP:", clientIp, "from", serviceUrl);
                        break; 
                    } else {
                         console.warn('IP data not found in response from:', serviceUrl, 'Response data:', data);
                    }
                } else {
                    console.warn('Failed to fetch IP from', serviceUrl, 'Status:', response.status);
                }
            } catch (error) {
                 if (error.name === 'AbortError') {
                    console.error('IP fetch timed out or aborted from:', serviceUrl);
                } else {
                    console.error('Error fetching IP from', serviceUrl, ':', error);
                }
            }
        }
        clientFetchedIpField.value = clientIp;
        return clientIp; 
    }

    function validateForm() {
        let isValid = true;
        document.querySelectorAll('#survey-section .help.is-danger').forEach(el => el.classList.add('hidden'));

        const phoneNumberInput = form.querySelector('input[name="phoneNumber"]');
        const phoneNumber = phoneNumberInput.value;
        const digitsOnly = phoneNumber.replace(/\D/g, '');
        if (digitsOnly.length !== 10) {
            phoneNumberError.textContent = 'Please enter a valid 10-digit phone number.';
            phoneNumberError.classList.remove('hidden');
            isValid = false;
        }

        const ageInput = form.querySelector('input[name="age"]');
        const age = parseInt(ageInput.value, 10);
        if (isNaN(age) || age < 18 || age > 99) {
            ageError.textContent = 'Please enter an age between 18 and 99.';
            ageError.classList.remove('hidden');
            isValid = false;
        }

        form.querySelectorAll('#survey-section [required]').forEach(input => {
            if (input.type === 'radio') {
                const radioGroup = document.querySelectorAll(`input[name="${input.name}"]:checked`);
                if (radioGroup.length === 0) {
                    const fieldDiv = input.closest('.field');
                    if (fieldDiv) {
                        let errorEl = fieldDiv.querySelector('.help.is-danger');
                        if (!errorEl) { 
                            errorEl = document.createElement('p');
                            errorEl.classList.add('help', 'is-danger');
                            fieldDiv.appendChild(errorEl);
                        }
                        errorEl.textContent = 'This field is required.';
                        errorEl.classList.remove('hidden');
                        isValid = false;
                    }
                }
            } else if (input.tagName === 'SELECT' && !input.value) {
                const fieldDiv = input.closest('.field');
                if (fieldDiv) {
                    let errorEl = fieldDiv.querySelector('.help.is-danger');
                    if (!errorEl) { 
                        errorEl = document.createElement('p');
                        errorEl.classList.add('help', 'is-danger');
                        fieldDiv.appendChild(errorEl);
                    }
                    errorEl.textContent = 'This field is required.';
                    errorEl.classList.remove('hidden');
                    isValid = false;
                }
            } else if (!input.value.trim() && input.type !== 'radio' && input.tagName !== 'SELECT') {
                const fieldDiv = input.closest('.field');
                if (fieldDiv) {
                    let errorEl = fieldDiv.querySelector('.help.is-danger');
                    if (!errorEl) { 
                        errorEl = document.createElement('p');
                        errorEl.classList.add('help', 'is-danger');
                        fieldDiv.appendChild(errorEl);
                    }
                    errorEl.textContent = 'This field is required.';
                    errorEl.classList.remove('hidden');
                    isValid = false;
                }
            }
        });
        return isValid;
    }

    async function submitDisqualification(reason) {
        setTimestamp(); 
        const tempFormData = new FormData();
        const age18OrOverSelected = document.querySelector('input[name="age18OrOverInitial"]:checked');
        const purchasePlanSelected = document.querySelector('input[name="purchaseInitial"]:checked');
        const paymentPlanSelected = document.querySelector('input[name="paymentPlanInitial"]:checked');

        tempFormData.append("age18OrOverInitial", age18OrOverSelected ? age18OrOverSelected.value : "Not answered");
        tempFormData.append("purchaseInitial", purchasePlanSelected ? purchasePlanSelected.value : "Not answered");
        tempFormData.append("paymentInitial", paymentPlanSelected ? paymentPlanSelected.value : "Not answered"); // Corrected parameter name
        tempFormData.append("timestamp", timestampField.value);
        tempFormData.append("disqualificationReason", reason);
        tempFormData.append("consentStatus", "Not Applicable - Ineligible");
        tempFormData.append("viewedWebpageUrl", "N/A - Ineligible");
        tempFormData.append("contentCertified", "Not Applicable - Ineligible");
        tempFormData.append("timeOnContentPageMs", "0");
        await fetchClientIp(); 
        tempFormData.append("clientFetchedIp", clientFetchedIpField.value); 
        tempFormData.append("fullName", "N/A"); 
        tempFormData.append("email", "N/A");
        tempFormData.append("phoneNumber", "N/A");
        tempFormData.append("age", "N/A");
        tempFormData.append("gender", "N/A");
        tempFormData.append("race", "N/A");
        tempFormData.append("hispanic", "N/A");
        tempFormData.append("education", "N/A");
        tempFormData.append("occupation", "N/A");
        tempFormData.append("householdIncome", "N/A");
        tempFormData.append("contactPreference", "N/A");
        tempFormData.append("newVehiclesPurchased", "N/A");
        // Append N/A for location fields for disqualified users
        tempFormData.append("latitude", "N/A");
        tempFormData.append("longitude", "N/A");
        tempFormData.append("locationAccuracy", "N/A");
        tempFormData.append("locationStatus", "Not Applicable - Ineligible");


        const formDataString = formatFormData(tempFormData);

        try {
            const response = await fetch(scriptURL, {
                method: "POST",
                redirect: "follow",
                body: formDataString,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            });
            if (!response.ok) {
                const data = await response.json().catch(() => response.text());
                throw new Error(`Server status ${response.status}: ${data.message || data || 'Unknown error'}`);
            }
            console.log('Apps Script Response (Ineligible):', await response.json());
            formCard.classList.add("hidden");
            duplicateMessage.classList.remove("hidden");
            duplicateMessage.innerHTML = '<p>Thank you for your interest. Unfortunately, you do not meet the eligibility criteria for this study at this time.</p>';
        } catch (error) {
            console.error('Error submitting ineligible data:', error);
            formCard.classList.add("hidden"); 
            duplicateMessage.classList.remove("hidden"); 
            duplicateMessage.innerHTML = '<p>Thank you, but you do not match the criteria for the survey.</p>'; 
            thankYouMessage.classList.add("hidden"); 
        }
    }

    ageNextBtn.addEventListener("click", function () {
      age18OrOverInitialError.classList.add('hidden'); 
      const age18OrOverSelected = document.querySelector('input[name="age18OrOverInitial"]:checked');
      if (!age18OrOverSelected) {
           age18OrOverInitialError.textContent = 'Please confirm if you are 18 or older.';
           age18OrOverInitialError.classList.remove('hidden');
           return;
      }
      if (age18OrOverSelected.value === 'No') {
          submitDisqualification("Under 18");
          return;
      }
      ageCheckSection.classList.add("hidden");
      purchasePlanSection.classList.remove("hidden");
    });

    purchaseNextBtn.addEventListener("click", function () {
        purchaseInitialError.classList.add('hidden'); 
        const purchasePlanSelected = document.querySelector('input[name="purchaseInitial"]:checked');
        if (!purchasePlanSelected) {
            purchaseInitialError.textContent = 'Please select your vehicle purchase plans.';
            purchaseInitialError.classList.remove('hidden');
            return;
        }
        if (purchasePlanSelected.value !== "Will buy new car within 1 month") { 
            submitDisqualification("Not buying new car within 1 month");
            return;
        }
        purchasePlanSection.classList.add("hidden");
        paymentPlanSection.classList.remove("hidden");
    });

    paymentNextBtn.addEventListener("click", function () {
        paymentPlanInitialError.classList.add('hidden'); 
        const paymentPlanSelected = document.querySelector('input[name="paymentPlanInitial"]:checked');
        if (!paymentPlanSelected) {
            paymentPlanInitialError.textContent = 'Please select your payment plan.';
            paymentPlanInitialError.classList.remove('hidden');
            return;
        }
        if (paymentPlanSelected.value !== "At least some financing") { 
            submitDisqualification("Not financing");
            return;
        }
        paymentPlanSection.classList.add("hidden");
        introExplanationContent.classList.add("hidden"); 
        consentModal.classList.add("is-active"); 
        setTimestamp(); 
    });

    consentBtn.addEventListener("click", function() {
      consentStatusField.value = "Consented";
      consentRequiredMessage.classList.add('hidden'); 

      const pdfUrl = "expedited-consent-template_05_19_2025.pdf"; 
      const link = document.createElement('a');
      link.href = pdfUrl;
      link.download = 'CarBuyingStudy_ConsentForm.pdf'; 
      document.body.appendChild(link); 
      link.click(); 
      document.body.removeChild(link); 

      consentModal.classList.remove("is-active");
      surveySection.classList.remove("hidden");
      formCard.classList.remove("hidden"); 

      // *** MODIFIED: Call getLocation() when survey section is shown ***
      getLocation(); // <--- THIS IS THE KEY ADDITION FOR LOCATION
    });

    function handleConsentModalClose() {
        consentModal.classList.remove("is-active");
        if (consentStatusField.value !== "Consented") {
            formCard.classList.add("hidden"); 
            consentRequiredMessage.classList.remove('hidden'); 
        }
    }

    closeConsentModal.addEventListener("click", handleConsentModalClose);
    consentModal.querySelector('.modal-background').addEventListener('click', handleConsentModalClose);

    reopenConsentBtn.addEventListener('click', function() {
        consentRequiredMessage.classList.add('hidden'); 
        formCard.classList.remove("hidden"); 
        consentModal.classList.add('is-active'); 
    });

    certifyBtn.addEventListener("click", async function() {
        contentCertifiedField.value = "Yes";
        recordContentModalTime(); 
        contentModal.classList.remove("is-active");
        webpageIframe.src = ""; 

        if (currentFormData) {
            currentFormData.set("contentCertified", contentCertifiedField.value);
            currentFormData.set("timeOnContentPageMs", timeOnContentPageMsField.value);
            currentFormData.set("viewedWebpageUrl", viewedWebpageUrlField.value); 
            await fetchClientIp(); 
            currentFormData.set("clientFetchedIp", clientFetchedIpField.value); 

            const formDataString = formatFormData(currentFormData); 

            demographicsSubmitBtn.classList.add('is-loading'); 
            demographicsSubmitBtn.disabled = true;

            fetch(scriptURL, {
                method: "POST",
                redirect: "follow",
                body: formDataString,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            })
            .then(response => {
                if (!response.ok) {
                     return response.json().then(data => { throw new Error(`Server status ${response.status}: ${data.message || 'Unknown error'}`); }).catch(() => { return response.text().then(text => { const snippet = text.substring(0, 200); throw new Error(`Server status ${response.status}. Raw response snippet: ${snippet}...`); }); });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.status === "success") {
                    thankYouMessage.classList.remove("hidden");
                    formCard.classList.add("hidden");
                    localStorage.setItem('carStudyCompleted', 'true'); 

                    // --- NEW REDIRECTION LOGIC: Redirect after successful submission ---
                    const randomIndex = Math.floor(Math.random() * postSubmissionRedirectUrls.length);
                    const redirectUrl = postSubmissionRedirectUrls[randomIndex];

                    // Redirect after a short delay to allow the "Thank you" message to be seen
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 2000); // 2 second delay before redirection
                    // --- END NEW REDIRECTION LOGIC ---

                } else if (data && data.status === "error") {
                    let errorMessage = data.message || 'Final submission failed.';
                    duplicateMessage.classList.remove('hidden');
                    duplicateMessage.innerHTML = '<p>' + errorMessage + '</p>';
                    formCard.classList.remove("hidden"); // Keep form visible to allow retry if appropriate
                    thankYouMessage.classList.add("hidden");
                } else {
                    duplicateMessage.classList.remove('hidden');
                    duplicateMessage.innerHTML = '<p>An unexpected error occurred during submission. Please try again later.</p>';
                    formCard.classList.remove("hidden");
                    thankYouMessage.classList.add("hidden");
                }
            })
            .catch(error => {
                duplicateMessage.classList.remove('hidden');
                duplicateMessage.innerHTML = '<p>There was a network error during submission. Please check your internet connection and try again.</p>';
                formCard.classList.remove("hidden");
                thankYouMessage.classList.add("hidden");
            })
            .finally(() => {
                demographicsSubmitBtn.classList.remove('is-loading');
                demographicsSubmitBtn.disabled = false;
            });
        } else {
            duplicateMessage.classList.remove('hidden');
            duplicateMessage.innerHTML = '<p>An internal error occurred. Please refresh the page and try again.</p>';
            formCard.classList.remove("hidden");
            thankYouMessage.classList.add("hidden");
        }
    });

    function handleContentModalClose() {
        recordContentModalTime(); 
        contentModal.classList.remove("is-active");
        webpageIframe.src = ""; 

        if (contentCertifiedField.value !== "Yes") {
            formCard.classList.add("hidden"); 
            contentRequiredMessage.classList.remove('hidden'); 
        }
    }

    closeContentModal.addEventListener("click", handleContentModalClose);
    contentModal.querySelector('.modal-background').addEventListener('click', handleContentModalClose);

    reopenContentBtn.addEventListener('click', function() {
        contentRequiredMessage.classList.add('hidden'); 
        formCard.classList.remove("hidden"); 
        contentModal.classList.add('is-active'); 
        webpageIframe.src = selectedWebpageUrl; 
        contentModalStartTime = new Date().getTime(); 
    });

        // --- Event Listener for Main Survey Form Submission (Demographics submit button) ---
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const submitButton = e.submitter || demographicsSubmitBtn; 
      submitButton.classList.add('is-loading');
      submitButton.disabled = true;

      duplicateMessage.classList.add('hidden');
      thankYouMessage.classList.add('hidden');
      consentRequiredMessage.classList.add('hidden');
      contentRequiredMessage.classList.add('hidden'); 
      // Clear any previous general location error that this submit handler might have set
      // but let specific messages from getLocation() persist unless overridden.
      // If locationMessage is already showing a specific error from getLocation(), this won't change it yet.
      if (locationMessage.textContent.includes("Location access is required to proceed")) {
          locationMessage.classList.remove('is-danger'); // Temporarily remove danger if it was from a previous submit click
          locationMessage.textContent = document.getElementById('locationStatusField').value === 'Granted' ? 'Location acquired. Thank you!' : 'Attempting to get your location for research purposes...'; // Reset to a neutral or success message if applicable
          if (document.getElementById('locationStatusField').value === 'Granted') {
            locationMessage.classList.add('has-text-success');
          } else {
            locationMessage.classList.add('is-info');
          }
      }


       if (!validateForm()) {
           console.log('Client-side validation failed.');
           if(submitButton) {
                submitButton.classList.remove('is-loading');
               submitButton.disabled = false;
           }
           return;
       }

       if (consentStatusField.value !== "Consented") {
            console.log('Consent not given.');
            formCard.classList.add("hidden");
            consentRequiredMessage.classList.remove('hidden');
            if(submitButton) {
                submitButton.classList.remove('is-loading');
                submitButton.disabled = false;
            }
            return;
       }

       // *** NEW: Mandatory Location Check ***
       if (locationStatusField.value !== 'Granted') {
            console.log('Location not granted. Status:', locationStatusField.value);
            locationMessage.textContent = 'Location access is required to proceed. Please grant permission and ensure location services are enabled. You may need to refresh the page or adjust browser settings if you previously denied it.';
            locationMessage.classList.remove('is-info', 'has-text-success');
            locationMessage.classList.add('is-danger');
            locationMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

            if(submitButton) {
                submitButton.classList.remove('is-loading');
                submitButton.disabled = false;
            }
            return; // Stop form submission
       }
       // *** END: Mandatory Location Check ***

       // If we've passed the location check, and it was previously showing an error from *this* submit handler,
       // ensure the message reflects the actual granted status.
       // getLocation() would have already set a success message if granted.
       if (locationStatusField.value === 'Granted') {
            locationMessage.textContent = 'Location acquired. Thank you!';
            locationMessage.classList.remove('is-info', 'is-danger');
            locationMessage.classList.add('has-text-success');
       }


       // Temporarily store the form data. Final submission will happen after content review.
       currentFormData = new FormData(e.target);

       // Append the initial eligibility responses to the temporary form data
       const age18OrOverInitial = document.querySelector('input[name="age18OrOverInitial"]:checked');
       currentFormData.append("age18OrOverInitial", age18OrOverInitial ? age18OrOverInitial.value : "Not Provided");
       const purchaseInitial = document.querySelector('input[name="purchaseInitial"]:checked');
       currentFormData.append("purchaseInitial", purchaseInitial ? purchaseInitial.value : "Not Provided");
       const paymentPlanInitial = document.querySelector('input[name="paymentPlanInitial"]:checked');
       currentFormData.append("paymentPlanInitial", paymentPlanInitial ? paymentPlanInitial.value : "Not Provided");

       setTimestamp(); // Update timestamp for the full form data
       currentFormData.set("timestamp", timestampField.value); // Use set to update existing

       // Select a random URL for the content modal
       const randomIndex = Math.floor(Math.random() * targetWebpages.length);
       selectedWebpageUrl = targetWebpages[randomIndex];
       viewedWebpageUrlField.value = selectedWebpageUrl; // Update hidden field with the URL that will be shown
       currentFormData.set("viewedWebpageUrl", selectedWebpageUrl); // Also add to stored FormData

       webpageIframe.src = selectedWebpageUrl;
       contentModal.classList.remove("hidden"); 
       contentModal.classList.add("is-active"); 

       contentModalStartTime = new Date().getTime(); 
       console.log('Demographics, consent, and location valid. Now opening content modal. Timer started.');
       // Don't hide surveySection immediately; allow submit button to remain visible but loading
       // surveySection.classList.add("hidden"); // This was hiding the button too soon
       // The button's state (loading, disabled) will handle user feedback.
       // The formCard itself isn't hidden here, only when a final message (thank you/error) is shown
       // or if consent/content review is required again.
    });

    // Initial Page Load Setup
    ageCheckSection.classList.remove("hidden");
    introExplanationContent.classList.remove("hidden");
    purchasePlanSection.classList.add("hidden");
    paymentPlanSection.classList.add("hidden");
    surveySection.classList.add("hidden"); 
    formCard.classList.remove("hidden"); 
    consentModal.classList.add("hidden"); 
    contentModal.classList.add("hidden"); 
  </script>

</body>
</html>
