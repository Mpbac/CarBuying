<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enrollment Form: Car Buying Study</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <style>
    :root {
      --dartmouth-green: #00693e;
      --forest-green: #228B22;
      --off-white: #f8f8f8;
    }

    body {
      background-color: var(--off-white);
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .form-card {
      max-width: 700px;
      margin: 20px auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 10px;
      overflow: hidden;
    }
    .hidden {
      display: none;
    }
    .message-box {
      margin: 20px auto;
      max-width: 600px;
      padding: 20px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
    }

    .message-box.is-danger {
       background-color: #f8d7da;
       color: #721c24;
       border-color: #f5c6cb;
    }

    .hero.is-primary.is-bold {
      background-color: var(--dartmouth-green);
      background-image: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .hero-body .container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero .title {
      color: white;
      font-size: 2.5em;
      font-weight: 600;
      margin-left: 1.5rem;
      margin-bottom: 0;
    }

    .banner-logo {
      max-height: 70px;
      width: auto;
    }

    .button.is-primary {
      background-color: var(--dartmouth-green);
      border-color: var(--dartmouth-green);
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .button.is-primary:hover,
    .button.is-primary:focus {
      background-color: #005a34;
      border-color: #005a34;
    }

    .button.is-success {
      background-color: var(--forest-green);
      border-color: var(--forest-green);
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .button.is-success:hover,
    .button.is-success:focus {
      background-color: #1e7d1e;
      border-color: #1e7d1e;
    }

    .label {
      font-weight: 600;
      color: #363636;
      margin-bottom: 0.75rem;
    }
    .field {
      margin-bottom: 1.5rem;
    }

    .input, .select select {
      border-color: #dbdbdb;
      box-shadow: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input:focus, .select select:focus, .textarea:focus {
      border-color: var(--forest-green);
      box-shadow: 0 0 0 0.125em rgba(34, 139, 34, 0.25);
    }

    .radio {
      margin-right: 1.5em;
      cursor: pointer;
    }

    .content p {
      line-height: 1.7;
      margin-bottom: 1em;
    }
    .content hr {
      background-color: #eee;
      height: 1px;
      margin: 2rem 0;
    }


    .modal-content {
      width: 95%;
      max-width: 1600px;
      height: 95%;
      max-height: 1200px;
      display: flex;
      flex-direction: column;
    }

    .modal-content .box {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      position: relative;
    }


    .iframe-container {
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      background-color: white;
    }

    .modal-content iframe {
      display: block;
      width: 100%;
      min-height: 100%;
      border: none;
    }

    .sticky-footer {
        position: sticky;
        bottom: 0;
        left: -20px;
        width: calc(100% + 40px);
        background-color: white;
        padding: 15px 20px;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 10;

        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .sticky-footer .confirm-text {
        margin-bottom: 10px !important;
        text-align: center;
        font-size: 0.9em;
    }

    .sticky-footer .control {
        width: 100%;
        text-align: center;
    }


    .modal .modal-close {
        top: 10px;
        right: 10px;
    }


    .help.is-danger {
        color: #f14668;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }


    @media (max-width: 768px) {
      .hero .title {
           font-size: 1.8em;
           margin-left: 1rem;
      }
       .hero-body .container {
           flex-direction: column;
           text-align: center;
      }
      .banner-logo {
           margin-bottom: 10px;
      }
      .hero .title {
           margin-left: 0;
      }
      .modal-content {
           width: 95%;
           height: 95%;
      }
       .modal-content .box {
         padding: 15px;
       }
        .sticky-footer {
            left: -15px;
            width: calc(100% + 30px);
            padding: 10px 15px;
        }
         .modal .modal-close {
             top: 5px;
             right: 5px;
         }
    }
  </style>
</head>
<body>

  <section class="hero is-primary is-bold">
    <div class="hero-body">
      <div class="container">
        <img src="D-Pine_Rev.png" alt="Dartmouth College Logo" class="banner-logo">
        <h1 class="title">Enrollment Form: Car Buying Study</h1>
      </div>
    </div>
  </section>

  <div class="card form-card" id="form-card">
    <div class="card-content">

      <div id="intro-explanation-content" class="content">
        <h2></h2>
        <p>Researchers at Dartmouth College are collecting information on car purchases and would like to pay YOU for your help.</p>
        <p>Answer just three questions to find out if you qualify to receive:</p>
        <ul>
          <li>$5 for completing a very short survey</li>
          <li>$20 for texting or emailing us readable pictures with the details of your car purchase and financing details.</li>
        </ul>
        <p>Your responses will be kept confidential and used for research purposes only.</p>
        <hr>
      </div>

      <form id="purchaseForm">
        <input type="hidden" name="timestamp" id="timestampField">
        <input type="hidden" name="consentStatus" id="consentStatusField" value="Not Applicable">
        <input type="hidden" name="viewedWebpageUrl" id="viewedWebpageUrlField" value="N/A">
        <input type="hidden" name="contentCertified" id="contentCertifiedField" value="No">
        <input type="hidden" name="timeOnContentPageMs" id="timeOnContentPageMsField" value="0">
        <input type="hidden" name="clientFetchedIp" id="clientFetchedIpField" value="N/A_ClientFetch_Skipped">

        
        <div class="field hidden">
          <label class="label" for="honeypotField">Leave this field empty</label>
          <div class="control">
            <input class="input" type="text" name="honeypot" id="honeypotField" tabindex="-1" autocomplete="off">
          </div>
        </div>

        <div id="age-check-section">
           <div class="field">
            <label class="label">Are you 18 years of age or older?</label>
             <div class="control">
              <label class="radio">
                <input type="radio" name="age18OrOverInitial" value="Yes" required> Yes
              </label>
              <label class="radio">
                <input type="radio" name="age18OrOverInitial" value="No" required> No
              </label>
             </div>
           </div>
           <p class="help is-danger hidden" id="age18OrOverInitialError"></p>
           <button class="button is-primary" type="button" id="ageNextBtn">Next</button>
        </div>

        <div id="purchase-plan-section" class="hidden">
           <div class="field">
                <label class="label">What are your vehicle purchase plans?</label>
                <div class="control">
                <label class="radio">
                    <input type="radio" name="purchaseInitial" value="Will buy new car within 1 month" required>
                    Will probably buy a new car within the next month
                </label><br>
                <label class="radio">
                    <input type="radio" name="purchaseInitial" value="Will buy used car within 1 month">
                    Will probably buy a used car within the next month
                </label><br>
                <label class="radio">
                    <input type="radio" name="purchaseInitial" value="No plans to buy car within 1 month">
                    No plans to buy a car within the next month
                </label>
                </div>
            </div>
            <p class="help is-danger hidden" id="purchaseInitialError"></p>
            <button class="button is-primary" type="button" id="purchaseNextBtn">Next</button>
        </div>

        <div id="payment-plan-section" class="hidden">
            <div class="field">
                <label class="label">How do you plan to pay for your car?</label>
                <div class="control">
                    <label class="radio">
                        <input type="radio" name="paymentPlanInitial" value="All cash" required> All cash
                    </label><br>
                    <label class="radio">
                        <input type="radio" name="paymentPlanInitial" value="At least some financing"> At least some financing
                    </label>
                </div>
            </div>
            <p class="help is-danger hidden" id="paymentPlanInitialError"></p>
            <button class="button is-primary" type="button" id="paymentNextBtn">Continue</button>
        </div>


        <div id="survey-section" class="hidden">
          <hr>
          <h3 class="title is-5">Contact & Demographic Information</h3>

          <div class="field">
            <label class="label">Full Name</label>
            <input class="input" type="text" name="fullName" required>
          </div>

          <div class="field">
            <label class="label">Email</label>
            <input class="input" type="email" name="email" id="emailField" required>
            <p class="help is-danger hidden" id="emailError"></p>
          </div>

           <div class="field">
            <label class="label">Phone Number</label>
            <input class="input" type="tel" name="phoneNumber" required>
             <p class="help is-danger hidden" id="phoneNumberError"></p>
           </div>


          <div class="field">
            <label class="label">Age</label>
            <input class="input" type="number" name="age" min="18" max="99" required>
             <p class="help is-danger hidden" id="ageError"></p>
          </div>

          <div class="field">
            <label class="label">Gender</label>
            <div class="control">
              <label class="radio"><input type="radio" name="gender" value="Male" required> Male</label>
              <label class="radio"><input type="radio" name="gender" value="Female"> Female</label>
              <label class="radio"><input type="radio" name="gender" value="Other"> Other</label>
            </div>
          </div>

          <div class="field">
            <label class="label">Race</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select name="race" required>
                  <option value="">Select your race</option>
                  <option value="White">White</option>
                  <option value="Black or African American">Black or African American</option>
                  <option value="American Indian or Alaska Native">American Indian or Alaska Native</option>
                  <option value="Asian">Asian</option>
                  <option value="Native Hawaiian or Other Pacific Islander">Native Hawaiian or Other Pacific Islander</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label">Are you Hispanic or Latino?</label>
            <div class="control">
              <label class="radio"><input type="radio" name="hispanic" value="Yes" required> Yes</label>
              <label class="radio"><input type="radio" name="hispanic" value="No"> No</label>
            </div>
          </div>

          <div class="field">
            <label class="label">Highest Level of Education</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select name="education" required>
                  <option value="">Select education level</option>
                  <option value="Some high school">Some high school</option>
                  <option value="High school">High school</option>
                  <option value="Some college">Some college</option>
                  <option value="Associate’s degree">Associate’s degree</option>
                  <option value="Bachelor’s degree">Bachelor’s degree</option>
                  <option value="Graduate degree">Graduate degree</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
             <label class="label">Occupation / Industry Role</label>
             <div class="control">
              <div class="select is-fullwidth">
               <select name="occupation" required>
                 <option value="">Select your occupation</option>
                  <option value="11-0000">Management Occupations</option>
                  <option value="13-0000">Business and Financial Operations Occupations</option>
                  <option value="15-0000">Computer and Mathematical Occupations</option>
                  <option value="17-0000">Architecture and Engineering Occupations</option>
                  <option value="19-0000">Life, Physical, and Social Science Occupations</option>
                  <option value="21-0000">Community and Social Service Occupations</option>
                  <option value="23-0000">Legal Occupations</option>
                  <option value="25-0000">Educational Instruction and Library Occupations</option>
                  <option value="27-0000">Arts, Design, Entertainment, Sports, and Media Occupations</option>
                  <option value="29-0000">Healthcare Practitioners and Technical Occupations</option>
                  <option value="31-0000">Healthcare Support Occupations</option>
                  <option value="33-0000">Protective Service Occupations</option>
                  <option value="35-0000">Food Preparation and Serving Related Occupations</option>
                  <option value="37-0000">Building and Grounds Cleaning and Maintenance Occupations</option>
                  <option value="39-0000">Personal Care and Service Occupations</option>
                  <option value="41-0000">Sales and Related Occupations</option>
                  <option value="43-0000">Office and Administrative Support Occupations</option>
                  <option value="45-0000">Farming, Fishing, and Forestry Occupations</option>
                  <option value="47-0000">Construction and Extraction Occupations</option>
                  <option value="49-0000">Installation, Maintenance, and Repair Occupations</option>
                  <option value="51-0000">Production Occupations</option>
                  <option value="53-0000">Transportation and Material Moving Occupations</option>
                  <option value="55-0000">Military Specific Occupations</option>
                  <option value="Student">Student</option>
                  <option value="Unemployed">Unemployed</option>
                  <option value="Retired">Retired</option>
                  <option value="Other">Other</option>
               </select>
              </div>
             </div>
           </div>

           <div class="field">
               <label class="label">Household Income</label>
               <div class="control">
                   <div class="select is-fullwidth">
                       <select name="householdIncome" required>
                           <option value="">Select your household income</option>
                           <option value="Under $15,000">Under $15,000</option>
                           <option value="$15,000 - $24,999">$15,000 - $24,999</option>
                           <option value="$25,000 - $34,999">$25,000 - $34,999</option>
                           <option value="$35,000 - $49,999">$35,000 - $49,999</option>
                           <option value="$50,000 - $74,999">$50,000 - $74,999</option>
                           <option value="$75,000 - $99,999">$74,999 - $99,999</option>
                           <option value="$100,000 - $149,999">$100,000 - $149,999</option>
                           <option value="$150,000 - $199,999">$150,000 - $199,999</option>
                           <option value="$200,000 or more">$200,000 or more</option>
                       </select>
                   </div>
               </div>
           </div>


           <div class="field">
             <label class="label">Preferred method for follow-up contact:</label>
              <div class="control">
               <label class="radio">
                 <input type="radio" name="contactPreference" value="Email" required> Email
               </label>
               <label class="radio">
                 <input type="radio" name="contactPreference" value="Text (SMS)"> Text (SMS)
               </label>
               <label class="radio">
                 <input type="radio" name="contactPreference" value="Both Email and Text"> Both Email and Text
               </label>
              </div>
            </div>

          <input type="hidden" name="latitude" id="latitudeField" value="N/A">
          <input type="hidden" name="longitude" id="longitudeField" value="N/A">
          <input type="hidden" name="locationAccuracy" id="locationAccuracyField" value="N/A">
          <input type="hidden" name="locationStatus" id="locationStatusField" value="Pending">

          <div class="field">
              <p class="help is-info" id="locationMessage">Attempting to get your location for research purposes...</p>
              <button class="button is-info is-small mt-2" type="button" id="shareLocationBtn">Share Location</button>
          </div>
          <div class="field">
            <label class="label">How many new vehicles have you purchased in your lifetime?</label>
            <input class="input" type="number" name="newVehiclesPurchased" min="0" required>
          </div>
          
          <div class="field">
            <button class="button is-success" type="submit" id="demographicsSubmitBtn">Submit Enrollment</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="thank-you" class="message-box hidden">
    <p class="title is-5 has-text-success">Thank you for completing the initial enrollment.</p>
    <p>Please look out for an email with further instructions.</p>
  </div>


  <div id="duplicate-message" class="message-box is-danger hidden"></div>

  <div id="consent-required-message" class="message-box is-danger hidden">
    <p class="title is-5 has-text-danger">Consent Required</p>
    <p>To participate in this study and proceed with the enrollment form, you must provide your consent.</p>
    <button class="button is-primary mt-4" id="reopenConsentBtn">Review Consent Form</button>
  </div>

  <div id="content-required-message" class="message-box is-danger hidden">
    <p class="title is-5 has-text-danger">Content Review Required</p>
    <p>You must review the provided content to proceed with the study.</p>
    <button class="button is-primary mt-4" id="reopenContentBtn">Review Content</button>
  </div>


  <div id="consent-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box">
        <h3 class="title is-4">Consent Form</h3>
        <p>Please review the consent form below:</p>
        <div class="pdf-viewer-container" style="flex-grow: 1; min-height: 300px; position: relative; margin-bottom: 20px;">
          <iframe src="expedited-consent-template_05_19_2025.pdf" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0"></iframe>
        </div>
        <div class="sticky-footer"> <p class="confirm-text">By clicking the "Consent" button below, you are indicating that I have read the above information about the Car Buying Study and have been given time to ask questions. I agree to take part in this study and I will be given a copy of this signed consent form.</p>
          <p class="control">
            <button class="button is-success" id="consentBtn">Consent</button>
          </p>
        </div>
      </div>
    </div>
    <button class="modal-close is-large" aria-label="close" id="closeConsentModal"></button>
  </div>

  <div id="content-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box">
        <h3 class="title is-4">Review Required Content</h3>
           <div class="iframe-container">
             <iframe id="webpageIframe" src="" frameborder="0"></iframe>
          </div>
        <div class="sticky-footer"> <p class="confirm-text">By clicking "I Certify...", you confirm that you have reviewed the content shown above.</p>
          <p class="control">
            <button class="button is-success" id="certifyBtn">I certify that I have reviewed this content</button>
          </p>
        </div>
      </div>
    </div>
       <button class="modal-close is-large" aria-label="close" id="closeContentModal"></button>
  </div>


     <script>
    // !!! REPLACE with your actual Google Apps Script Web App URL for this study data submission !!!
    const scriptURL = "https://script.google.com/macros/s/AKfycbzR0R21CHTJvYXI5mOwIkIV3kVQSa9AC0dby7Hv4J6ODXRCgJ-1XYbh_R7tKGECykly/exec";

    const timestampField = document.getElementById("timestampField");
    const form = document.getElementById("purchaseForm");
    const thankYouMessage = document.getElementById("thank-you");
    const duplicateMessage = document.getElementById("duplicate-message");
    const formCard = document.getElementById("form-card");
    const introExplanationContent = document.getElementById("intro-explanation-content");

    // Elements for initial screening (now sequential)
    const ageCheckSection = document.getElementById("age-check-section");
    const purchasePlanSection = document.getElementById("purchase-plan-section");
    const paymentPlanSection = document.getElementById("payment-plan-section");

    const ageNextBtn = document.getElementById("ageNextBtn");
    const purchaseNextBtn = document.getElementById("purchaseNextBtn");
    const paymentNextBtn = document.getElementById("paymentNextBtn");
    const demographicsSubmitBtn = document.getElementById("demographicsSubmitBtn"); // New reference to demographics submit button

    const age18OrOverInitialError = document.getElementById('age18OrOverInitialError');
    const purchaseInitialError = document.getElementById('purchaseInitialError');
    const paymentPlanInitialError = document.getElementById('paymentPlanInitialError');

    // Elements for survey section (Demographics)
    const surveySection = document.getElementById("survey-section");

    // Consent modal elements
    const consentModal = document.getElementById("consent-modal");
    const consentBtn = document.getElementById("consentBtn");
    const closeConsentModal = document.getElementById("closeConsentModal");

    // Content modal elements
    const contentModal = document.getElementById("content-modal");
    const webpageIframe = document.getElementById("webpageIframe");
    const certifyBtn = document.getElementById("certifyBtn");
    const closeContentModal = document.getElementById("closeContentModal");

    // Hidden form fields
    const consentStatusField = document.getElementById("consentStatusField");
    const viewedWebpageUrlField = document.getElementById("viewedWebpageUrlField");
    const contentCertifiedField = document.getElementById("contentCertifiedField");
    const timeOnContentPageMsField = document.getElementById("timeOnContentPageMsField");
    const clientFetchedIpField = document.getElementById('clientFetchedIpField');

    // Bot protection field
    const honeypotField = document.getElementById('honeypotField');

    // Validation error elements for the *main survey* fields
    const phoneNumberError = document.getElementById('phoneNumberError');
    const ageError = document.getElementById('ageError');
    const emailField = document.getElementById('emailField');
    const emailError = document.getElementById('emailError');


    // Consent Required Message elements
    const consentRequiredMessage = document.getElementById('consent-required-message');
    const reopenConsentBtn = document.getElementById('reopenConsentBtn');

    // Content Required Message elements
    const contentRequiredMessage = document.getElementById('content-required-message');
    const reopenContentBtn = document.getElementById('reopenContentBtn');

    const latitudeField = document.getElementById('latitudeField');
    const longitudeField = document.getElementById('longitudeField');
    const locationAccuracyField = document.getElementById('locationAccuracyField');
    const locationStatusField = document.getElementById('locationStatusField');
    const locationMessage = document.getElementById('locationMessage');
    const shareLocationBtn = document.getElementById('shareLocationBtn');

    // Array of target webpages for the content modal
    const targetWebpages = [
      "Treatment content.pdf",
      "Treatment content.pdf",
      "Treatment content.pdf"
    ];
    let selectedWebpageUrl = null; // Store the chosen URL for the content modal
    let contentModalStartTime = null; // Used for time tracking in content modal
    let currentFormData = null; // To store form data temporarily before final submission

    /*
    // !!! TEMPORARILY DISABLED FOR TESTING !!!
    if (localStorage.getItem('carStudyCompleted')) {
      console.log('Local Storage flag found: Survey already completed in this browser.');
      formCard.classList.add('hidden');
      duplicateMessage.classList.remove('hidden');
      duplicateMessage.innerHTML = '<p>Thank you for your participation. Our records indicate that you have already completed this survey using this browser.</p>';
      thankYouMessage.classList.add('hidden');
      ageNextBtn.disabled = true; // Disable initial next button
      demographicsSubmitBtn.disabled = true; // Disable demographics submit button
    } else {
      setTimestamp();
      console.log('No Local Storage flag found. Setting initial timestamp.');
    }
    // !!! TO RE-ENABLE, UNCOMMENT THE ABOVE BLOCK AND REMOVE THIS COMMENT BLOCK !!!
    */
    // If Local Storage check is disabled, ensure timestamp is set on load
    if (!localStorage.getItem('carStudyCompleted')) {
      setTimestamp();
      console.log('Local Storage check disabled. Setting initial timestamp.');
    }

    // Call fetchClientIp on page load to start the process early.
    // This gives the asynchronous IP fetch time to complete while the user fills out the form.
    document.addEventListener('DOMContentLoaded', fetchClientIp);

    function setTimestamp() {
      const now = new Date();
      const timestampString = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2) + '-' + ('0' + now.getDate()).slice(-2) + ' ' + ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2) + ':' + ('0' + now.getSeconds()).slice(-2);
      timestampField.value = timestampString;
    }

    function formatFormData(formData) {
      const params = new URLSearchParams();
      for (const pair of formData.entries()) {
        params.append(pair[0], pair[1]);
      }
      return params.toString();
    }

    function recordContentModalTime() {
      if (contentModalStartTime !== null) {
        const now = new Date().getTime();
        const duration = now - contentModalStartTime;
        timeOnContentPageMsField.value = duration;
        console.log(`Time on content modal: ${duration} ms`);
        contentModalStartTime = null;
      }
    }

    function getLocation() {
      if (navigator.geolocation) {
        locationMessage.textContent = 'Requesting your location. This is required for study participation and helps us understand regional differences.';
        locationMessage.classList.remove('is-danger', 'has-text-success');
        locationMessage.classList.add('is-info');

        const geoOptions = {
          enableHighAccuracy: true, // Request the most accurate location
          timeout: 10000,           // Time out after 10 seconds
          maximumAge: 0             // Don't use a cached position
        };

        navigator.geolocation.getCurrentPosition(
          (position) => {
            latitudeField.value = position.coords.latitude;
            longitudeField.value = position.coords.longitude;
            locationAccuracyField.value = position.coords.accuracy;
            locationStatusField.value = "Granted";
            locationMessage.textContent = `Location obtained: Lat ${position.coords.latitude.toFixed(4)}, Lon ${position.coords.longitude.toFixed(4)}. Accuracy: ${position.coords.accuracy.toFixed(2)} meters.` ;
            locationMessage.classList.remove('is-info');
            locationMessage.classList.add('has-text-success');
            console.log('Geolocation granted and obtained:', position.coords);
          },
          (error) => {
            let errorMessage = "Location access denied or an error occurred.";
            if (error.code === error.PERMISSION_DENIED) {
              errorMessage = "Location access denied. Please enable location services for this site to participate.";
              locationStatusField.value = "Denied";
            } else if (error.code === error.POSITION_UNAVAILABLE) {
              errorMessage = "Location information is unavailable. Please check your device settings.";
              locationStatusField.value = "Unavailable";
            } else if (error.code === error.TIMEOUT) {
              errorMessage = "Location request timed out. Please try again or check your internet connection.";
              locationStatusField.value = "Timeout";
            }
            locationMessage.textContent = `Error: ${errorMessage}`;
            locationMessage.classList.remove('is-info', 'has-text-success');
            locationMessage.classList.add('is-danger');
            console.error('Geolocation error:', error);
          },
          geoOptions
        );
      } else {
        locationMessage.textContent = "Geolocation is not supported by your browser.";
        locationMessage.classList.remove('is-info', 'has-text-success');
        locationMessage.classList.add('is-danger');
        locationStatusField.value = "Unsupported";
        console.warn("Geolocation is not supported by this browser.");
      }
    }

    // Function to validate email format
    function validateEmail() {
        const email = emailField.value;
        // Basic regex for email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
        if (emailRegex.test(email)) {
            emailError.classList.add('hidden');
            emailField.classList.remove('is-danger');
            return true;
        } else {
            emailError.textContent = 'Please enter a valid email address.';
            emailError.classList.remove('hidden');
            emailField.classList.add('is-danger');
            return false;
        }
    }

    // Event listeners for email validation
    emailField.addEventListener('blur', validateEmail);
    emailField.addEventListener('input', () => { // Clear error on input
        if (!emailError.classList.contains('hidden')) {
            emailError.classList.add('hidden');
            emailField.classList.remove('is-danger');
        }
    });

    // Event listener for the new Share Location button
    shareLocationBtn.addEventListener('click', getLocation);

    // Initial call to getLocation when the page loads, but without the timeout
    // document.addEventListener('DOMContentLoaded', getLocation); // Removed as button will trigger


    // Event listener for form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // Prevent default form submission

      // Perform client-side email validation again on submit
      if (!validateEmail()) {
          alert("Please correct the email address before submitting.");
          return; 
      }

      // Re-fetch location just before submission if it's still 'Pending' or 'Denied'
      if (latitudeField.value === 'N/A' || locationStatusField.value === 'Pending' || locationStatusField.value === 'Denied') {
          // You might want to force a re-attempt or alert the user
          // For now, we'll just log and proceed with N/A or current status
          console.warn("Location not fully obtained or denied. Submitting with current location status.");
          // Optionally, alert the user or prevent submission:
          // alert("Please share your location to proceed with the study.");
          // return;
      }


      // Disable the submit button and show a loading indicator
      demographicsSubmitBtn.classList.add('is-loading');
      demographicsSubmitBtn.disabled = true;

      // Capture all form data
      const formData = new FormData(form);
      currentFormData = formData; // Store for potential re-submission handling

      // Log current form data for debugging
      console.log("Submitting form data:");
      for (let [key, value] of formData.entries()) {
          console.log(`${key}: ${value}`);
      }

      try {
        const response = await fetch(scriptURL, {
          method: "POST",
          body: formData,
          mode: "no-cors" // Use no-cors for Google Apps Script to avoid CORS preflight issues
        });

        // Due to "no-cors", response.ok will always be true and status will be 0.
        // We need to handle success/error based on a redirect or a pre-defined success message in a real scenario.
        // For Google Apps Script, a successful POST usually results in a redirect or a simple response.
        // We rely on the App Script to handle duplicate checks and eligibility.

        console.log("Form submitted. Waiting for App Script to process.");

        // For "no-cors" mode, we cannot directly read the response body.
        // The success/error handling for duplicates or eligibility must be managed by the Apps Script
        // which would typically redirect or update the UI based on its own logic if it were a full web app.
        // Here, we assume if fetch doesn't throw an error, the Apps Script received it.
        // Real-world scenario would use CORS and read JSON response.

        // This client-side code will assume success after a fetch without errors.
        // The Apps Script itself handles what to do with duplicates.

        // If the Apps Script successfully processed, it will eventually show a thank you.
        // The "duplicate-message" and "thank-you" sections are typically controlled by the Apps Script redirect,
        // or by a client-side success message if CORS allows reading the response.
        // Since we cannot read response in no-cors, we'll manually show success here for demonstration.

        // In a real application, you'd typically make an AJAX request with CORS enabled
        // and then parse the JSON response from the Apps Script to show success or error.
        // Example:
        // const response = await fetch(scriptURL, { method: "POST", body: formData });
        // const result = await response.json();
        // if (result.status === "success") { showThankYou(); } else { showErrorMessage(result.message); }

        // For this example with no-cors, we show thank you assuming success unless network error.
        // The App Script will handle actual duplicate checking and email sending.
        showThankYou();
        localStorage.setItem('carStudyCompleted', 'true'); // Set flag for this browser
        console.log('Setting localStorage.carStudyCompleted to true.');

      } catch (error) {
        console.error("Submission failed:", error);
        formCard.classList.add('hidden');
        duplicateMessage.classList.remove('hidden');
        duplicateMessage.innerHTML = `<p class="title is-5 has-text-danger">Submission Failed</p><p>An error occurred: ${error.message}. Please try again.</p>`;
        thankYouMessage.classList.add('hidden');
      } finally {
        demographicsSubmitBtn.classList.remove('is-loading');
        demographicsSubmitBtn.disabled = false;
      }
    });

    function showThankYou() {
      formCard.classList.add('hidden');
      thankYouMessage.classList.remove('hidden');
      duplicateMessage.classList.add('hidden'); // Hide any duplicate messages if showing
      consentRequiredMessage.classList.add('hidden');
      contentRequiredMessage.classList.add('hidden');
    }

    function showDuplicateMessage(message) {
        formCard.classList.add('hidden');
        duplicateMessage.classList.remove('hidden');
        duplicateMessage.innerHTML = `<p class="title is-5 has-text-danger">Submission Error</p><p>${message}</p>`;
        thankYouMessage.classList.add('hidden');
        consentRequiredMessage.classList.add('hidden');
        contentRequiredMessage.classList.add('hidden');
    }


    // Consent Modal Logic
    consentBtn.addEventListener('click', () => {
      consentStatusField.value = "Consented";
      consentModal.classList.remove("is-active");
      console.log('Consent granted.');

      // After consent, determine next step: review content or proceed to survey
      const ageRadio = document.querySelector('input[name="age18OrOverInitial"]:checked');
      if (ageRadio && ageRadio.value === 'Yes') {
        // If age is already confirmed, show purchase plan
        ageCheckSection.classList.add("hidden");
        purchasePlanSection.classList.remove("hidden");
        console.log('Age confirmed, showing purchase plan.');
      } else {
        // If age not confirmed or "No", show age check
        ageCheckSection.classList.remove("hidden");
        console.log('Age not confirmed or "No", showing age check.');
      }

      introExplanationContent.classList.remove("hidden");
      formCard.classList.remove("hidden");
    });

    closeConsentModal.addEventListener('click', () => {
      consentModal.classList.remove("is-active");
      consentStatusField.value = "Not Consented - Closed Modal"; // User closed without consenting
      console.log('Consent modal closed without explicit consent.');
      consentRequiredMessage.classList.remove('hidden');
      formCard.classList.add("hidden"); // Hide form if consent not given
    });

    reopenConsentBtn.addEventListener('click', () => {
        consentModal.classList.add("is-active");
        consentRequiredMessage.classList.add('hidden');
        formCard.classList.add("hidden");
    });


    // Content Modal Logic
    certifyBtn.addEventListener('click', () => {
      contentCertifiedField.value = "Yes";
      recordContentModalTime(); // Record time spent on content
      contentModal.classList.remove("is-active");
      console.log('Content certified.');

      // After content certification, show the survey section
      surveySection.classList.remove("hidden");
      console.log('Showing survey section.');
    });

    closeContentModal.addEventListener('click', () => {
      contentModal.classList.remove("is-active");
      contentCertifiedField.value = "No - Closed Modal";
      recordContentModalTime(); // Record time spent even if closed
      console.log('Content modal closed without certification.');
      contentRequiredMessage.classList.remove('hidden');
      surveySection.classList.add("hidden"); // Hide survey if content not certified
      formCard.classList.add("hidden");
    });

    reopenContentBtn.addEventListener('click', () => {
        // Re-open content modal, selecting a random webpage again
        let randomIndex = Math.floor(Math.random() * targetWebpages.length);
        selectedWebpageUrl = targetWebpages[randomIndex];
        viewedWebpageUrlField.value = selectedWebpageUrl; // Update hidden field with the URL that will be shown
        webpageIframe.src = selectedWebpageUrl;
        contentModal.classList.add("is-active");
        contentRequiredMessage.classList.add('hidden');
        formCard.classList.add("hidden");
        contentModalStartTime = new Date().getTime(); // Restart timer
    });

    // Sequential Form Navigation Logic
    ageNextBtn.addEventListener('click', () => {
        const ageRadio = document.querySelector('input[name="age18OrOverInitial"]:checked');
        if (!ageRadio) {
            age18OrOverInitialError.textContent = 'Please select an option.';
            age18OrOverInitialError.classList.remove('hidden');
            return;
        } else {
            age18OrOverInitialError.classList.add('hidden');
        }

        if (ageRadio.value === 'No') {
            // Disqualify and submit immediately
            const formData = new FormData(form);
            formData.set('disqualificationReason', 'Under 18');
            formData.set('consentStatus', 'Not Applicable - Under 18'); // Set appropriate consent status
            submitDisqualification(formData);
            return;
        }

        ageCheckSection.classList.add('hidden');
        purchasePlanSection.classList.remove('hidden');
    });

    purchaseNextBtn.addEventListener('click', () => {
        const purchaseRadio = document.querySelector('input[name="purchaseInitial"]:checked');
        if (!purchaseRadio) {
            purchaseInitialError.textContent = 'Please select an option.';
            purchaseInitialError.classList.remove('hidden');
            return;
        } else {
            purchaseInitialError.classList.add('hidden');
        }

        if (purchaseRadio.value === 'No plans to buy car within 1 month') {
            // Disqualify and submit immediately
            const formData = new FormData(form);
            formData.set('disqualificationReason', 'No plans to buy car within 1 month');
            formData.set('consentStatus', 'Not Applicable - No Car Purchase Plans');
            submitDisqualification(formData);
            return;
        }

        purchasePlanSection.classList.add('hidden');
        paymentPlanSection.classList.remove('hidden');
    });

    paymentNextBtn.addEventListener('click', () => {
        const paymentRadio = document.querySelector('input[name="paymentPlanInitial"]:checked');
        if (!paymentRadio) {
            paymentPlanInitialError.textContent = 'Please select an option.';
            paymentPlanInitialError.classList.remove('hidden');
            return;
        } else {
            paymentPlanInitialError.classList.add('hidden');
        }

        // All initial screening questions passed, now check consent
        if (consentStatusField.value !== "Consented") {
            consentModal.classList.add("is-active");
            formCard.classList.add("hidden"); // Hide the form behind the modal
            introExplanationContent.classList.add("hidden");
            console.log('Initial screening passed, opening consent modal.');
        } else if (contentCertifiedField.value !== "Yes") {
            // If consent is already given, but content not reviewed, show content modal
            console.log('Consent already given, opening content modal for review.');
            let randomIndex = Math.floor(Math.random() * targetWebpages.length);
            selectedWebpageUrl = targetWebpages[randomIndex];
            viewedWebpageUrlField.value = selectedWebpageUrl; // Update hidden field with the URL that will be shown
            webpageIframe.src = selectedWebpageUrl;
            contentModal.classList.add("is-active");
            contentModalStartTime = new Date().getTime();
            formCard.classList.add("hidden"); // Hide the form behind the modal
            introExplanationContent.classList.add("hidden");
        } else {
            // If both consent and content are handled, proceed to survey
            paymentPlanSection.classList.add("hidden");
            surveySection.classList.remove("hidden");
            console.log('Consent and content reviewed, showing survey section.');
        }

        // Hide other sections if they were visible, ensure smooth transition
        ageCheckSection.classList.add("hidden");
        purchasePlanSection.classList.add("hidden");
        paymentPlanSection.classList.add("hidden"); // Keep this hidden after clicking continue
    });


    async function submitDisqualification(formData) {
        demographicsSubmitBtn.classList.add('is-loading');
        demographicsSubmitBtn.disabled = true;

        console.log("Submitting disqualification data:", Object.fromEntries(formData.entries()));

        try {
            const response = await fetch(scriptURL, {
                method: "POST",
                body: formData,
                mode: "no-cors"
            });
            console.log("Disqualification submitted successfully (no-cors assumed success).");
            formCard.classList.add('hidden');
            thankYouMessage.classList.add('hidden'); // Hide thank you
            duplicateMessage.classList.remove('hidden'); // Use duplicate message div for disqualify message
            duplicateMessage.innerHTML = `<p class="title is-5 has-text-warning">Thank you for your interest!</p><p>Based on your responses, you do not meet the current eligibility criteria for this study. We appreciate your time.</p>`;
            localStorage.setItem('carStudyCompleted', 'true'); // Set flag even for disqualified to prevent re-attempts
        } catch (error) {
            console.error("Disqualification submission failed:", error);
            formCard.classList.add('hidden');
            duplicateMessage.classList.remove('hidden');
            duplicateMessage.innerHTML = `<p class="title is-5 has-text-danger">Submission Failed</p><p>An error occurred during disqualification submission: ${error.message}. Please try again.</p>`;
        } finally {
            demographicsSubmitBtn.classList.remove('is-loading');
            demographicsSubmitBtn.disabled = false;
        }
    }

    // Initial Page Load Setup
    document.addEventListener('DOMContentLoaded', () => {
        ageCheckSection.classList.remove("hidden");
        introExplanationContent.classList.remove("hidden");
        purchasePlanSection.classList.add("hidden");
        paymentPlanSection.classList.add("hidden");
        surveySection.classList.add("hidden"); 
        formCard.classList.remove("hidden"); 
        consentModal.classList.add("hidden"); 
        contentModal.classList.add("hidden"); 
    });
  </script>

</body>
</html>
